<!DOCTYPE html><html lang="zh-CN" data-theme="light"><head><meta charset="UTF-8"><meta http-equiv="X-UA-Compatible" content="IE=edge"><meta name="viewport" content="width=device-width, initial-scale=1.0,viewport-fit=cover"><title>Android中的IPC方式 | Auroraの世界</title><meta name="author" content="Aurora"><meta name="copyright" content="Aurora"><meta name="format-detection" content="telephone=no"><meta name="theme-color" content="#ffffff"><meta name="description" content="Bundle典型应用场景 当我们在一个进程中启动了另一进程的Activity，Service和Receiver，我们就可以在Bundle中附加我们需要传输给远程进程的信息并通过Intent发送出去。当然这个数据必须能够被序列化，比如基本数据类型，实现了Parcelable接口的对象，实现了Serializable接口的对象以及一些Android支持的特殊对象。 特殊使用场景 比如A进程正在进行一个">
<meta property="og:type" content="article">
<meta property="og:title" content="Android中的IPC方式">
<meta property="og:url" content="https://buyu6.github.io/posts/Android%E4%B8%AD%E7%9A%84IPC%E6%96%B9%E5%BC%8F/index.html">
<meta property="og:site_name" content="Auroraの世界">
<meta property="og:description" content="Bundle典型应用场景 当我们在一个进程中启动了另一进程的Activity，Service和Receiver，我们就可以在Bundle中附加我们需要传输给远程进程的信息并通过Intent发送出去。当然这个数据必须能够被序列化，比如基本数据类型，实现了Parcelable接口的对象，实现了Serializable接口的对象以及一些Android支持的特殊对象。 特殊使用场景 比如A进程正在进行一个">
<meta property="og:locale" content="zh_CN">
<meta property="og:image" content="https://buyu6.github.io/bgImg/bg4.jpg">
<meta property="article:published_time" content="2025-10-09T13:24:30.000Z">
<meta property="article:modified_time" content="2025-12-19T14:25:50.299Z">
<meta property="article:author" content="Aurora">
<meta property="article:tag" content="Android, Kotlin, 个人博客, 学习笔记">
<meta name="twitter:card" content="summary">
<meta name="twitter:image" content="https://buyu6.github.io/bgImg/bg4.jpg"><script type="application/ld+json">{
  "@context": "https://schema.org",
  "@type": "BlogPosting",
  "headline": "Android中的IPC方式",
  "url": "https://buyu6.github.io/posts/Android%E4%B8%AD%E7%9A%84IPC%E6%96%B9%E5%BC%8F/",
  "image": "https://buyu6.github.io/bgImg/bg4.jpg",
  "datePublished": "2025-10-09T13:24:30.000Z",
  "dateModified": "2025-12-19T14:25:50.299Z",
  "author": [
    {
      "@type": "Person",
      "name": "Aurora",
      "url": "https://buyu6.github.io"
    }
  ]
}</script><link rel="shortcut icon" href="/img/avatar.jpg"><link rel="canonical" href="https://buyu6.github.io/posts/Android%E4%B8%AD%E7%9A%84IPC%E6%96%B9%E5%BC%8F/index.html"><link rel="preconnect" href="//cdn.jsdelivr.net"/><link rel="stylesheet" href="/css/index.css?v=5.5.3"><link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/@fortawesome/fontawesome-free@7.1.0/css/all.min.css"><script>
    (() => {
      
    const saveToLocal = {
      set: (key, value, ttl) => {
        if (!ttl) return
        const expiry = Date.now() + ttl * 86400000
        localStorage.setItem(key, JSON.stringify({ value, expiry }))
      },
      get: key => {
        const itemStr = localStorage.getItem(key)
        if (!itemStr) return undefined
        const { value, expiry } = JSON.parse(itemStr)
        if (Date.now() > expiry) {
          localStorage.removeItem(key)
          return undefined
        }
        return value
      }
    }

    window.btf = {
      saveToLocal,
      getScript: (url, attr = {}) => new Promise((resolve, reject) => {
        const script = document.createElement('script')
        script.src = url
        script.async = true
        Object.entries(attr).forEach(([key, val]) => script.setAttribute(key, val))
        script.onload = script.onreadystatechange = () => {
          if (!script.readyState || /loaded|complete/.test(script.readyState)) resolve()
        }
        script.onerror = reject
        document.head.appendChild(script)
      }),
      getCSS: (url, id) => new Promise((resolve, reject) => {
        const link = document.createElement('link')
        link.rel = 'stylesheet'
        link.href = url
        if (id) link.id = id
        link.onload = link.onreadystatechange = () => {
          if (!link.readyState || /loaded|complete/.test(link.readyState)) resolve()
        }
        link.onerror = reject
        document.head.appendChild(link)
      }),
      addGlobalFn: (key, fn, name = false, parent = window) => {
        if (!false && key.startsWith('pjax')) return
        const globalFn = parent.globalFn || {}
        globalFn[key] = globalFn[key] || {}
        globalFn[key][name || Object.keys(globalFn[key]).length] = fn
        parent.globalFn = globalFn
      }
    }
  
      
      const activateDarkMode = () => {
        document.documentElement.setAttribute('data-theme', 'dark')
        if (document.querySelector('meta[name="theme-color"]') !== null) {
          document.querySelector('meta[name="theme-color"]').setAttribute('content', '#0d0d0d')
        }
      }
      const activateLightMode = () => {
        document.documentElement.setAttribute('data-theme', 'light')
        if (document.querySelector('meta[name="theme-color"]') !== null) {
          document.querySelector('meta[name="theme-color"]').setAttribute('content', '#ffffff')
        }
      }

      btf.activateDarkMode = activateDarkMode
      btf.activateLightMode = activateLightMode

      const theme = saveToLocal.get('theme')
    
          theme === 'dark' ? activateDarkMode() : theme === 'light' ? activateLightMode() : null
        
      
      const asideStatus = saveToLocal.get('aside-status')
      if (asideStatus !== undefined) {
        document.documentElement.classList.toggle('hide-aside', asideStatus === 'hide')
      }
    
      
    const detectApple = () => {
      if (/iPad|iPhone|iPod|Macintosh/.test(navigator.userAgent)) {
        document.documentElement.classList.add('apple')
      }
    }
    detectApple()
  
    })()
  </script><script>const GLOBAL_CONFIG = {
  root: '/',
  algolia: undefined,
  localSearch: {"path":"/search.json","preload":false,"top_n_per_article":1,"unescape":false,"pagination":{"enable":false,"hitsPerPage":8},"languages":{"hits_empty":"未找到符合您查询的内容：${query}","hits_stats":"共找到 ${hits} 篇文章"}},
  translate: undefined,
  highlight: {"plugin":"highlight.js","highlightCopy":true,"highlightLang":true,"highlightHeightLimit":false,"highlightFullpage":false,"highlightMacStyle":true},
  copy: {
    success: '复制成功',
    error: '复制失败',
    noSupport: '浏览器不支持'
  },
  relativeDate: {
    homepage: false,
    post: false
  },
  runtime: '',
  dateSuffix: {
    just: '刚刚',
    min: '分钟前',
    hour: '小时前',
    day: '天前',
    month: '个月前'
  },
  copyright: undefined,
  lightbox: 'null',
  Snackbar: undefined,
  infinitegrid: {
    js: 'https://cdn.jsdelivr.net/npm/@egjs/infinitegrid@4.12.0/dist/infinitegrid.min.js',
    buttonText: '加载更多'
  },
  isPhotoFigcaption: false,
  islazyloadPlugin: false,
  isAnchor: false,
  percent: {
    toc: true,
    rightside: false,
  },
  autoDarkmode: false
}</script><script id="config-diff">var GLOBAL_CONFIG_SITE = {
  title: 'Android中的IPC方式',
  isHighlightShrink: false,
  isToc: true,
  pageType: 'post'
}</script><meta name="referrer" content="no-referrer-when-downgrade"><link rel="stylesheet" href="/css/custom.css"><meta name="generator" content="Hexo 8.1.1"></head><body><div class="bg-animation" id="web_bg" style="background-image: url(/img/background.jpg);"></div><div id="sidebar"><div id="menu-mask"></div><div id="sidebar-menus"><div class="avatar-img text-center"><img src="/img/avatar.jpg" onerror="this.onerror=null;this.src='/img/friend_404.gif'" alt="avatar"/></div><div class="site-data text-center"><a href="/archives/"><div class="headline">文章</div><div class="length-num">68</div></a><a href="/tags/"><div class="headline">标签</div><div class="length-num">0</div></a><a href="/categories/"><div class="headline">分类</div><div class="length-num">11</div></a></div><div class="menus_items"><div class="menus_item"><a class="site-page" href="/"><i class="fa-fw fas fa-home"></i><span> 首页</span></a></div><div class="menus_item"><a class="site-page" href="/archives/"><i class="fa-fw fas fa-archive"></i><span> 归档</span></a></div><div class="menus_item"><a class="site-page" href="/categories/"><i class="fa-fw fas fa-folder-open"></i><span> 分类</span></a></div><div class="menus_item"><a class="site-page" href="/about/"><i class="fa-fw fas fa-heart"></i><span> 关于</span></a></div></div></div></div><div class="post" id="body-wrap"><header class="post-bg fixed" id="page-header" style="background-image: url(/bgImg/bg4.jpg);"><nav id="nav"><span id="blog-info"><a class="nav-site-title" href="/"><img class="site-icon" src="/img/avatar.jpg" alt="Logo"><span class="site-name">Auroraの世界</span></a><a class="nav-page-title" href="/"><span class="site-name">Android中的IPC方式</span><span class="site-name"><i class="fa-solid fa-circle-arrow-left"></i><span>  返回首页</span></span></a></span><div id="menus"><div id="search-button"><span class="site-page social-icon search"><i class="fas fa-search fa-fw"></i><span> 搜索</span></span></div><div class="menus_items"><div class="menus_item"><a class="site-page" href="/"><i class="fa-fw fas fa-home"></i><span> 首页</span></a></div><div class="menus_item"><a class="site-page" href="/archives/"><i class="fa-fw fas fa-archive"></i><span> 归档</span></a></div><div class="menus_item"><a class="site-page" href="/categories/"><i class="fa-fw fas fa-folder-open"></i><span> 分类</span></a></div><div class="menus_item"><a class="site-page" href="/about/"><i class="fa-fw fas fa-heart"></i><span> 关于</span></a></div></div><div id="toggle-menu"><span class="site-page"><i class="fas fa-bars fa-fw"></i></span></div></div></nav><div id="post-info"><h1 class="post-title">Android中的IPC方式</h1><div id="post-meta"><div class="meta-firstline"><span class="post-meta-date"><i class="far fa-calendar-alt fa-fw post-meta-icon"></i><span class="post-meta-label">发表于</span><time class="post-meta-date-created" datetime="2025-10-09T13:24:30.000Z" title="发表于 2025-10-09 21:24:30">2025-10-09</time><span class="post-meta-separator">|</span><i class="fas fa-history fa-fw post-meta-icon"></i><span class="post-meta-label">更新于</span><time class="post-meta-date-updated" datetime="2025-12-19T14:25:50.299Z" title="更新于 2025-12-19 22:25:50">2025-12-19</time></span><span class="post-meta-categories"><span class="post-meta-separator">|</span><i class="fas fa-inbox fa-fw post-meta-icon"></i><a class="post-meta-categories" href="/categories/Android%E8%BF%9B%E9%98%B6/">Android进阶</a></span></div><div class="meta-secondline"><span class="post-meta-separator">|</span><span class="post-meta-wordcount"><i class="far fa-file-word fa-fw post-meta-icon"></i><span class="post-meta-label">总字数:</span><span class="word-count">6.1k</span><span class="post-meta-separator">|</span><i class="far fa-clock fa-fw post-meta-icon"></i><span class="post-meta-label">阅读时长:</span><span>28分钟</span></span><span class="post-meta-separator">|</span><span class="post-meta-pv-cv" id="" data-flag-title=""><i class="far fa-eye fa-fw post-meta-icon"></i><span class="post-meta-label">浏览量:</span><span id="busuanzi_value_page_pv"><i class="fa-solid fa-spinner fa-spin"></i></span></span></div></div></div></header><main class="layout" id="content-inner"><div id="post"><article class="container post-content" id="article-container"><h3 id="Bundle"><a href="#Bundle" class="headerlink" title="Bundle"></a>Bundle</h3><p><strong>典型应用场景</strong></p>
<p>当我们在一个进程中启动了另一进程的Activity，Service和Receiver，我们就可以在Bundle中附加我们需要传输给远程进程的信息并通过Intent发送出去。当然这个数据必须能够被序列化，比如基本数据类型，实现了Parcelable接口的对象，实现了Serializable接口的对象以及一些Android支持的特殊对象。</p>
<p><strong>特殊使用场景</strong></p>
<p>比如A进程正在进行一个计算，计算完成后它要启动B进程的一个组件并把计算结果传递给B进程，可是遗憾的是此结果不支持放入Bundle中。这个时候可以使用如下方法：</p>
<p>通过Intent启动进程B的一个Service组件（比如IntentService），让Service在后台进行计算，计算完毕后再启动B进程中的目标组件，由于Service也在B进程中，所以目标组件可以直接获得计算结果。</p>
<hr>
<h3 id="使用文件共享"><a href="#使用文件共享" class="headerlink" title="使用文件共享"></a>使用文件共享</h3><p><strong>概括</strong>：两个进程通过读写同一个文件来交换数据</p>
<p><strong>过程：</strong></p>
<ul>
<li><p>将数据序列化到文件中</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">private</span> <span class="keyword">void</span> <span class="title function_">persistToFile</span><span class="params">()</span>&#123;</span><br><span class="line">       <span class="keyword">new</span> <span class="title class_">Thread</span>(<span class="keyword">new</span> <span class="title class_">Runnable</span>() &#123;</span><br><span class="line">           <span class="meta">@Override</span></span><br><span class="line">           <span class="keyword">public</span> <span class="keyword">void</span> <span class="title function_">run</span><span class="params">()</span> &#123;</span><br><span class="line">               File baseDir=getBaseContext().getFilesDir();</span><br><span class="line">               User user=<span class="keyword">new</span> <span class="title class_">User</span>(<span class="literal">false</span>,<span class="number">1</span>,<span class="string">&quot;hello world&quot;</span>);</span><br><span class="line">               File dir=<span class="keyword">new</span> <span class="title class_">File</span>(baseDir,MyConstants.CHAPTER_2_PATH);</span><br><span class="line">               <span class="keyword">if</span>(!dir.exists())&#123;</span><br><span class="line">                   dir.mkdirs();</span><br><span class="line">               &#125;</span><br><span class="line">               File cachedFile=<span class="keyword">new</span> <span class="title class_">File</span>(dir,MyConstants.CACHE_FILE_PATH);</span><br><span class="line">               ObjectOutputStream objectOutputStream=<span class="literal">null</span>;</span><br><span class="line">               <span class="keyword">try</span> &#123;</span><br><span class="line">                   objectOutputStream=<span class="keyword">new</span> <span class="title class_">ObjectOutputStream</span>(<span class="keyword">new</span> <span class="title class_">FileOutputStream</span>(cachedFile));</span><br><span class="line">                   objectOutputStream.writeObject(user);</span><br><span class="line">                   Log.d(TAG, <span class="string">&quot;persist user:&quot;</span>+user);</span><br><span class="line">               &#125;<span class="keyword">catch</span> (IOException e)&#123;</span><br><span class="line">                   e.printStackTrace();</span><br><span class="line">               &#125;<span class="keyword">finally</span> &#123;</span><br><span class="line">                   MyUtils.close(objectOutputStream);</span><br><span class="line">               &#125;</span><br><span class="line">           &#125;</span><br><span class="line">       &#125;).start();</span><br><span class="line">   &#125;</span><br></pre></td></tr></table></figure>


</li>
<li><p>反序列化读取</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">private</span> <span class="keyword">void</span> <span class="title function_">recoverFromFile</span><span class="params">()</span>&#123;</span><br><span class="line">        <span class="keyword">new</span> <span class="title class_">Thread</span>(<span class="keyword">new</span> <span class="title class_">Runnable</span>() &#123;</span><br><span class="line">            <span class="meta">@Override</span></span><br><span class="line">            <span class="keyword">public</span> <span class="keyword">void</span> <span class="title function_">run</span><span class="params">()</span> &#123;</span><br><span class="line">                User user=<span class="literal">null</span>;</span><br><span class="line">                File baseDir=getBaseContext().getFilesDir();</span><br><span class="line">                <span class="type">File</span> <span class="variable">dir</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">File</span>(baseDir, MyConstants.CHAPTER_2_PATH);</span><br><span class="line">                File cacheFile=<span class="keyword">new</span> <span class="title class_">File</span>(dir,MyConstants.CACHE_FILE_PATH);</span><br><span class="line">                <span class="keyword">if</span>(cacheFile.exists())&#123;</span><br><span class="line">                    ObjectInputStream objectInputStream=<span class="literal">null</span>;</span><br><span class="line">                    <span class="keyword">try</span> &#123;</span><br><span class="line">                        objectInputStream =<span class="keyword">new</span> <span class="title class_">ObjectInputStream</span>(</span><br><span class="line">                                <span class="keyword">new</span> <span class="title class_">FileInputStream</span>(cacheFile)</span><br><span class="line">                        );</span><br><span class="line">                        user=(User) objectInputStream.readObject();</span><br><span class="line">                        Log.d(TAG, <span class="string">&quot;recover user:&quot;</span>+user);</span><br><span class="line">                    &#125;<span class="keyword">catch</span> ( IOException e)&#123;</span><br><span class="line">                        e.printStackTrace();</span><br><span class="line">                    &#125;<span class="keyword">catch</span> (ClassNotFoundException e)&#123;</span><br><span class="line">                        e.printStackTrace();</span><br><span class="line">                    &#125;<span class="keyword">finally</span> &#123;</span><br><span class="line">                        MyUtils.close(objectInputStream);</span><br><span class="line">                    &#125;</span><br><span class="line">                &#125;</span><br><span class="line">            &#125;</span><br><span class="line">        &#125;).start();</span><br><span class="line">    &#125;</span><br></pre></td></tr></table></figure>

<p><strong>局限性</strong>：受并发读&#x2F;写的影响，故此方法适合对数据同步要求不高的进程之间进行通信，并且要妥善处理并发读写的问题</p>
</li>
</ul>
<hr>
<h3 id="Messenger"><a href="#Messenger" class="headerlink" title="Messenger"></a>Messenger</h3><ul>
<li><p><strong>服务端进程</strong></p>
<p>首先需要创建一个Service来处理连接请求，同时创建一个Handle并通过它来创建一个Messener对象，然后在Service的onBind中返回这个Messenger对象底层的Binder即可。</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="keyword">class</span> <span class="title class_">MessengerService</span> <span class="keyword">extends</span> <span class="title class_">Service</span> &#123;</span><br><span class="line">    <span class="keyword">private</span> <span class="keyword">static</span> <span class="keyword">final</span> <span class="type">String</span> <span class="variable">TAG</span> <span class="operator">=</span> <span class="string">&quot;MessengerService&quot;</span> ;</span><br><span class="line">    <span class="keyword">public</span> <span class="title function_">MessengerService</span><span class="params">()</span> &#123;</span><br><span class="line">    &#125;</span><br><span class="line"><span class="keyword">private</span> <span class="keyword">static</span> <span class="keyword">class</span> <span class="title class_">MessengerHandler</span> <span class="keyword">extends</span> <span class="title class_">Handler</span>&#123;</span><br><span class="line">    <span class="meta">@Override</span></span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">void</span> <span class="title function_">handleMessage</span><span class="params">(<span class="meta">@NonNull</span> Message msg)</span> &#123;</span><br><span class="line">        <span class="keyword">switch</span> (msg.what)&#123;</span><br><span class="line">            <span class="keyword">case</span> MyConstants.MSG_FROM_CLIENT:</span><br><span class="line">                Log.i(TAG, <span class="string">&quot;receive msg from Client:&quot;</span>+msg.getData().getString(<span class="string">&quot;msg&quot;</span>));</span><br><span class="line">                <span class="comment">//为了实现回复客户端的功能新增代码</span></span><br><span class="line">                Messenger client=msg.replyTo;</span><br><span class="line">                Message replyMessage=Message.obtain(<span class="literal">null</span>,MyConstants.MSG_FROM_SERVICE);</span><br><span class="line">                Bundle bundle=<span class="keyword">new</span> <span class="title class_">Bundle</span>();</span><br><span class="line">                bundle.putString(<span class="string">&quot;reply&quot;</span>,<span class="string">&quot;嗯，我已经收到了&quot;</span>);</span><br><span class="line">                replyMessage.setData(bundle);</span><br><span class="line">                <span class="keyword">try</span>&#123;</span><br><span class="line">                    client.send(replyMessage);</span><br><span class="line">                &#125;<span class="keyword">catch</span> (RemoteException e)&#123;</span><br><span class="line">                    e.printStackTrace();</span><br><span class="line">                &#125;</span><br><span class="line">                <span class="keyword">break</span>;</span><br><span class="line">            <span class="keyword">default</span>:</span><br><span class="line">                <span class="built_in">super</span>.handleMessage(msg);</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br><span class="line"><span class="keyword">private</span> <span class="keyword">final</span> Messenger mMessenger=<span class="keyword">new</span> <span class="title class_">Messenger</span>(<span class="keyword">new</span> <span class="title class_">MessengerHandler</span>());</span><br><span class="line">    <span class="meta">@Override</span></span><br><span class="line">    <span class="keyword">public</span> IBinder <span class="title function_">onBind</span><span class="params">(Intent intent)</span> &#123;</span><br><span class="line">     <span class="keyword">return</span> mMessenger.getBinder();</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>让service运行在单独的进程中</p>
</li>
<li><p><strong>客户端进程</strong></p>
<p>首先要绑定服务端的service，绑定成功后用服务端返回的IBinder对象创建一个Messenger，通过这个Messenger就可以向服务端发送消息了，发消息类型为Message对象。如果需要服务端可以回应客户端，就和服务端一样，我们需要创建一个Handle并通过它来创建一个Messener对象，并把这个Messenger对象通过Message的replyTo参数传递给服务端，服务端通过这个replyTo参数就可以回应客户端</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="keyword">class</span> <span class="title class_">MessengerActivity</span> <span class="keyword">extends</span> <span class="title class_">AppCompatActivity</span> &#123;</span><br><span class="line">    <span class="keyword">private</span> <span class="keyword">static</span> <span class="keyword">final</span> String TAG=<span class="string">&quot;MessengerActivity&quot;</span>;</span><br><span class="line">    <span class="keyword">private</span> Messenger mService;</span><br><span class="line">    <span class="keyword">private</span> ServiceConnection mConnection=<span class="keyword">new</span> <span class="title class_">ServiceConnection</span>() &#123;</span><br><span class="line">        <span class="meta">@Override</span></span><br><span class="line">        <span class="keyword">public</span> <span class="keyword">void</span> <span class="title function_">onServiceConnected</span><span class="params">(ComponentName name, IBinder service)</span> &#123;</span><br><span class="line">            mService=<span class="keyword">new</span> <span class="title class_">Messenger</span>(service);</span><br><span class="line">            Message msg= Message.obtain(<span class="literal">null</span>,MyConstants.MSG_FROM_CLIENT);</span><br><span class="line">             Bundle data=<span class="keyword">new</span> <span class="title class_">Bundle</span>();</span><br><span class="line">             data.putString(<span class="string">&quot;msg&quot;</span>,<span class="string">&quot;hello , this is client&quot;</span>);</span><br><span class="line">             msg.setData(data);</span><br><span class="line">            <span class="comment">//注意下面这句话</span></span><br><span class="line">            msg.replyTo=mGetReplyMessenger;</span><br><span class="line">             <span class="keyword">try</span> &#123;</span><br><span class="line">                 mService.send(msg);</span><br><span class="line">             &#125;<span class="keyword">catch</span> (RemoteException e)&#123;</span><br><span class="line">                 e.printStackTrace();</span><br><span class="line">             &#125;</span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line">        <span class="meta">@Override</span></span><br><span class="line">        <span class="keyword">public</span> <span class="keyword">void</span> <span class="title function_">onServiceDisconnected</span><span class="params">(ComponentName name)</span> &#123;</span><br><span class="line"></span><br><span class="line">        &#125;</span><br><span class="line">    &#125;;</span><br><span class="line"></span><br><span class="line">    <span class="meta">@Override</span></span><br><span class="line">    <span class="keyword">protected</span> <span class="keyword">void</span> <span class="title function_">onCreate</span><span class="params">(Bundle savedInstanceState)</span> &#123;</span><br><span class="line">        <span class="built_in">super</span>.onCreate(savedInstanceState);</span><br><span class="line">        setContentView(R.layout.activity_messenger);</span><br><span class="line">        Intent intent=<span class="keyword">new</span> <span class="title class_">Intent</span>(<span class="built_in">this</span>,MessengerService.class);</span><br><span class="line">        bindService(intent,mConnection, Context.BIND_AUTO_CREATE);</span><br><span class="line"></span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">    <span class="meta">@Override</span></span><br><span class="line">    <span class="keyword">protected</span> <span class="keyword">void</span> <span class="title function_">onDestroy</span><span class="params">()</span> &#123;</span><br><span class="line">        unbindService(mConnection);</span><br><span class="line">        <span class="built_in">super</span>.onDestroy();</span><br><span class="line">    &#125;</span><br><span class="line">   <span class="comment">//为了实现回复客户端的功能新增代码</span></span><br><span class="line">    <span class="keyword">private</span> Messenger mGetReplyMessenger=<span class="keyword">new</span> <span class="title class_">Messenger</span>(<span class="keyword">new</span> <span class="title class_">MessengerHandler</span>());</span><br><span class="line">    <span class="keyword">private</span> <span class="keyword">static</span> <span class="keyword">class</span> <span class="title class_">MessengerHandler</span> <span class="keyword">extends</span> <span class="title class_">Handler</span>&#123;</span><br><span class="line">        <span class="meta">@Override</span></span><br><span class="line">        <span class="keyword">public</span> <span class="keyword">void</span> <span class="title function_">handleMessage</span><span class="params">(<span class="meta">@NonNull</span> Message msg)</span> &#123;</span><br><span class="line">            <span class="keyword">switch</span> (msg.what)&#123;</span><br><span class="line">                <span class="keyword">case</span> MyConstants.MSG_FROM_SERVICE:</span><br><span class="line">                    Log.i(TAG, <span class="string">&quot;receive msg from Service:&quot;</span>+msg.getData().getString(<span class="string">&quot;reply&quot;</span>));</span><br><span class="line">                    <span class="keyword">break</span>;</span><br><span class="line">                <span class="keyword">default</span>:</span><br><span class="line">                    <span class="built_in">super</span>.handleMessage(msg);</span><br><span class="line">            &#125;</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<ul>
<li><p><strong>工作原理示意图</strong></p>
<p><img src="/../img/img130.jpg"></p>
</li>
</ul>
</li>
</ul>
<p>.</p>
<hr>
<h3 id="AIDL"><a href="#AIDL" class="headerlink" title="AIDL"></a>AIDL</h3><ul>
<li><p><strong>AIDL文件支持的数据类型</strong></p>
<ol>
<li>基本数据类型(int,long,char,boolean,double等)</li>
<li>String和CharSequence</li>
<li>List：只支持ArrayList，里面每个元素都能被AIDL支持</li>
<li>Map：只支持HashMap，里面每个元素都能被AIDL支持，包括key和value</li>
<li>Parcelable:所有实现了Parcelable接口的对象</li>
<li>AIDL：所有AIDL接口本身也可以在AIDL文件中使用</li>
</ol>
</li>
<li><p><strong>注意事项</strong></p>
<ol>
<li>自定义的Parcelable对象和AIDL对象必须要显式的import进来</li>
<li>如果AIDL文件用到了自定义的Parcelable对象，那么必须新建一个与他同名的AIDL文件，并在其中声明他是Parcelable类型</li>
<li>AIDL中除了基本数据类型，其他类型的参数都必须标上方向：in，out和inout，in表示输入型参数，out表示输出型参数，inout表示输入输出型参数</li>
<li>AIDL接口中只支持方法，不支持声明静态常量，这一点区别于传统的接口,</li>
</ol>
</li>
<li><p><strong>实现当有新书时把信息告知给用户的功能</strong></p>
<ol>
<li><p>新建AIDL接口，让服务端能够主动通知客户端</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">//导入自定义的数据类型。</span></span><br><span class="line"><span class="keyword">import</span> com.example.ipctest.Book;</span><br><span class="line"><span class="keyword">interface</span> <span class="title class_">IOnNewBookArrivedListener</span> &#123;</span><br><span class="line">    <span class="comment">//in是从调用方指向被调用法，out相反</span></span><br><span class="line">    <span class="keyword">void</span> <span class="title function_">onNewBookArrived</span><span class="params">(in Book newBook)</span>;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>


</li>
<li><p>在原来的AIDL接口中添加两个新方法</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">//导入自定义的数据类型。</span></span><br><span class="line"><span class="keyword">import</span> com.example.ipctest.Book;</span><br><span class="line"></span><br><span class="line"><span class="keyword">import</span> com.example.ipctest.IOnNewBookArrivedListener;</span><br><span class="line"><span class="keyword">interface</span> <span class="title class_">IBookManager</span> &#123;</span><br><span class="line">        List&lt;Book&gt; <span class="title function_">getBookList</span><span class="params">()</span>;</span><br><span class="line">        <span class="keyword">void</span> <span class="title function_">addBook</span><span class="params">(in Book book)</span>;</span><br><span class="line">    <span class="comment">//新增</span></span><br><span class="line">        <span class="keyword">void</span> <span class="title function_">registerListener</span><span class="params">(IOnNewBookArrivedListener listener)</span>;</span><br><span class="line">        <span class="keyword">void</span> <span class="title function_">unregisterListener</span><span class="params">(IOnNewBookArrivedListener listener)</span>;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>


</li>
<li><p>服务端</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br><span class="line">95</span><br><span class="line">96</span><br><span class="line">97</span><br><span class="line">98</span><br><span class="line">99</span><br><span class="line">100</span><br><span class="line">101</span><br><span class="line">102</span><br><span class="line">103</span><br><span class="line">104</span><br><span class="line">105</span><br><span class="line">106</span><br><span class="line">107</span><br><span class="line">108</span><br><span class="line">109</span><br><span class="line">110</span><br><span class="line">111</span><br><span class="line">112</span><br><span class="line">113</span><br><span class="line">114</span><br><span class="line">115</span><br><span class="line">116</span><br><span class="line">117</span><br><span class="line">118</span><br><span class="line">119</span><br><span class="line">120</span><br><span class="line">121</span><br><span class="line">122</span><br><span class="line">123</span><br><span class="line">124</span><br><span class="line">125</span><br><span class="line">126</span><br><span class="line">127</span><br><span class="line">128</span><br><span class="line">129</span><br><span class="line">130</span><br><span class="line">131</span><br><span class="line">132</span><br><span class="line">133</span><br><span class="line">134</span><br><span class="line">135</span><br><span class="line">136</span><br><span class="line">137</span><br><span class="line">138</span><br><span class="line">139</span><br><span class="line">140</span><br><span class="line">141</span><br><span class="line">142</span><br><span class="line">143</span><br><span class="line">144</span><br><span class="line">145</span><br><span class="line">146</span><br><span class="line">147</span><br><span class="line">148</span><br><span class="line">149</span><br><span class="line">150</span><br><span class="line">151</span><br><span class="line">152</span><br><span class="line">153</span><br><span class="line">154</span><br><span class="line">155</span><br><span class="line">156</span><br><span class="line">157</span><br><span class="line">158</span><br><span class="line">159</span><br><span class="line">160</span><br><span class="line">161</span><br><span class="line">162</span><br><span class="line">163</span><br><span class="line">164</span><br><span class="line">165</span><br><span class="line">166</span><br><span class="line">167</span><br><span class="line">168</span><br><span class="line">169</span><br><span class="line">170</span><br><span class="line">171</span><br><span class="line">172</span><br><span class="line">173</span><br><span class="line">174</span><br><span class="line">175</span><br><span class="line">176</span><br><span class="line">177</span><br><span class="line">178</span><br><span class="line">179</span><br><span class="line">180</span><br><span class="line">181</span><br><span class="line">182</span><br><span class="line">183</span><br><span class="line">184</span><br><span class="line">185</span><br><span class="line">186</span><br><span class="line">187</span><br><span class="line">188</span><br><span class="line">189</span><br><span class="line">190</span><br><span class="line">191</span><br><span class="line">192</span><br><span class="line">193</span><br><span class="line">194</span><br><span class="line">195</span><br><span class="line">196</span><br><span class="line">197</span><br><span class="line">198</span><br><span class="line">199</span><br><span class="line">200</span><br><span class="line">201</span><br><span class="line">202</span><br><span class="line">203</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="keyword">class</span> <span class="title class_">BookManagerService</span> <span class="keyword">extends</span> <span class="title class_">Service</span> &#123;</span><br><span class="line">    <span class="keyword">private</span> <span class="keyword">static</span> <span class="keyword">final</span> <span class="type">String</span> <span class="variable">TAG</span> <span class="operator">=</span> <span class="string">&quot;BMS&quot;</span>;</span><br><span class="line">    <span class="comment">//作为一个线程安全的标志位（flag），用来记录 Service 是否已经被销毁。可以在多线程中启用</span></span><br><span class="line">    <span class="keyword">private</span> <span class="type">AtomicBoolean</span> <span class="variable">mIsServiceDestoryed</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">AtomicBoolean</span>(<span class="literal">false</span>);</span><br><span class="line">    <span class="keyword">private</span> CopyOnWriteArrayList&lt;Book&gt; mBookList = <span class="keyword">new</span> <span class="title class_">CopyOnWriteArrayList</span>&lt;Book&gt;();</span><br><span class="line">    <span class="keyword">private</span> RemoteCallbackList&lt;IOnNewBookArrivedListener&gt; mListenerList = <span class="keyword">new</span> <span class="title class_">RemoteCallbackList</span>&lt;IOnNewBookArrivedListener&gt;();</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">    <span class="keyword">private</span> <span class="type">Binder</span> <span class="variable">mBinder</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">IBookManager</span>.Stub() &#123;</span><br><span class="line">        <span class="meta">@Override</span></span><br><span class="line">        <span class="keyword">public</span> List&lt;Book&gt; <span class="title function_">getBookList</span><span class="params">()</span> <span class="keyword">throws</span> RemoteException &#123;</span><br><span class="line">            <span class="keyword">return</span> mBookList;</span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line">        <span class="meta">@Override</span></span><br><span class="line">        <span class="keyword">public</span> <span class="keyword">void</span> <span class="title function_">addBook</span><span class="params">(Book book)</span> <span class="keyword">throws</span> RemoteException &#123;</span><br><span class="line">            mBookList.add(book);</span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line">        <span class="meta">@Override</span></span><br><span class="line">        <span class="keyword">public</span> <span class="keyword">void</span> <span class="title function_">registerListener</span><span class="params">(IOnNewBookArrivedListener listener)</span> <span class="keyword">throws</span> RemoteException &#123;</span><br><span class="line">            <span class="comment">// 直接调用 register 方法即可。</span></span><br><span class="line">            <span class="comment">// 它内部会自动处理重复注册的情况，所以你不需要手动检查 contains。</span></span><br><span class="line">            mListenerList.register(listener);</span><br><span class="line">            Log.d(TAG, <span class="string">&quot;registerListener complete.&quot;</span>);</span><br><span class="line">            <span class="comment">// beginBroadcast() 会返回当前有效的监听器数量</span></span><br><span class="line">            <span class="type">int</span> <span class="variable">N</span> <span class="operator">=</span> mListenerList.beginBroadcast();</span><br><span class="line">            mListenerList.finishBroadcast();</span><br><span class="line">            Log.d(TAG, <span class="string">&quot;current listener size: &quot;</span> + N);</span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line">        <span class="meta">@Override</span></span><br><span class="line">        <span class="keyword">public</span> <span class="keyword">void</span> <span class="title function_">unregisterListener</span><span class="params">(IOnNewBookArrivedListener listener)</span> <span class="keyword">throws</span> RemoteException &#123;</span><br><span class="line">            <span class="comment">// unregister() 方法会返回一个 boolean 值，表示是否成功移除了监听器。</span></span><br><span class="line">            <span class="comment">// 这个方法是原子操作，并且能正确处理 Binder 对象。</span></span><br><span class="line">            <span class="type">boolean</span> <span class="variable">success</span> <span class="operator">=</span> mListenerList.unregister(listener);</span><br><span class="line"></span><br><span class="line">            <span class="keyword">if</span> (success) &#123;</span><br><span class="line">                Log.d(TAG, <span class="string">&quot;unregister listener succeed.&quot;</span>);</span><br><span class="line">            &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">                Log.d(TAG, <span class="string">&quot;not found, can not unregister.&quot;</span>);</span><br><span class="line">            &#125;</span><br><span class="line"></span><br><span class="line">            <span class="comment">// 获取当前有效监听器数量的正确方式</span></span><br><span class="line">            <span class="keyword">final</span> <span class="type">int</span> <span class="variable">N</span> <span class="operator">=</span> mListenerList.beginBroadcast();</span><br><span class="line">            mListenerList.finishBroadcast();</span><br><span class="line">            Log.d(TAG, <span class="string">&quot;unregisterListener, current size: &quot;</span> + N);</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;;</span><br><span class="line">        <span class="meta">@Override</span></span><br><span class="line">        <span class="keyword">public</span> <span class="keyword">void</span> <span class="title function_">onCreate</span><span class="params">()</span> &#123;</span><br><span class="line">            <span class="built_in">super</span>.onCreate();</span><br><span class="line">            mBookList.add(<span class="keyword">new</span> <span class="title class_">Book</span>(<span class="number">1</span>, <span class="string">&quot;Android&quot;</span>));</span><br><span class="line">            mBookList.add(<span class="keyword">new</span> <span class="title class_">Book</span>(<span class="number">2</span>, <span class="string">&quot;Ios&quot;</span>));</span><br><span class="line">            <span class="keyword">new</span> <span class="title class_">Thread</span>(<span class="keyword">new</span> <span class="title class_">ServiceWorker</span>()).start();</span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line">        <span class="meta">@Override</span></span><br><span class="line">        <span class="keyword">public</span> IBinder <span class="title function_">onBind</span><span class="params">(Intent intent)</span> &#123;</span><br><span class="line">            <span class="keyword">return</span> mBinder;</span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line">        <span class="meta">@Override</span></span><br><span class="line">        <span class="keyword">public</span> <span class="keyword">void</span> <span class="title function_">onDestroy</span><span class="params">()</span> &#123;</span><br><span class="line">           <span class="comment">// 通知后台线程停止工作</span></span><br><span class="line">            mIsServiceDestoryed.set(<span class="literal">true</span>);</span><br><span class="line">            <span class="built_in">super</span>.onDestroy();</span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">private</span> <span class="keyword">void</span> <span class="title function_">onNewBookArrived</span><span class="params">(Book book)</span> &#123;</span><br><span class="line">        <span class="comment">// 1. 先将书加入列表</span></span><br><span class="line">        mBookList.add(book);</span><br><span class="line">        Log.d(TAG, <span class="string">&quot;New book added: &quot;</span> + book + <span class="string">&quot;. Notifying listeners...&quot;</span>);</span><br><span class="line"></span><br><span class="line">        <span class="comment">// 2. 开始广播，获取有效监听器数量</span></span><br><span class="line">        <span class="keyword">final</span> <span class="type">int</span> <span class="variable">N</span> <span class="operator">=</span> mListenerList.beginBroadcast();</span><br><span class="line">        <span class="keyword">try</span> &#123;</span><br><span class="line">            <span class="comment">// 3. 在 beginBroadcast 和 finishBroadcast 之间遍历并通知</span></span><br><span class="line">            <span class="keyword">for</span> (<span class="type">int</span> <span class="variable">i</span> <span class="operator">=</span> <span class="number">0</span>; i &lt; N; i++) &#123;</span><br><span class="line">                <span class="type">IOnNewBookArrivedListener</span> <span class="variable">listener</span> <span class="operator">=</span> mListenerList.getBroadcastItem(i);</span><br><span class="line">                <span class="keyword">if</span> (listener != <span class="literal">null</span>) &#123;</span><br><span class="line">                    <span class="keyword">try</span> &#123;</span><br><span class="line">                        Log.d(TAG, <span class="string">&quot;Notifying listener: &quot;</span> + listener);</span><br><span class="line">                        <span class="comment">// 调用客户端的回调方法</span></span><br><span class="line">                        listener.onNewBookArrived(book);</span><br><span class="line">                    &#125; <span class="keyword">catch</span> (RemoteException e) &#123;</span><br><span class="line">                        <span class="comment">// 某个客户端可能在调用期间死亡或发生其他远程错误</span></span><br><span class="line">                        <span class="comment">// RemoteCallbackList 会在下次 beginBroadcast 时自动清理它</span></span><br><span class="line">                        e.printStackTrace();</span><br><span class="line">                    &#125;</span><br><span class="line">                &#125;</span><br><span class="line">            &#125;</span><br><span class="line">        &#125; <span class="keyword">finally</span> &#123;</span><br><span class="line">            <span class="comment">// 4. 确保在任何情况下都结束广播（即使循环中发生异常）</span></span><br><span class="line">            mListenerList.finishBroadcast();</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">        <span class="keyword">private</span> <span class="keyword">class</span> <span class="title class_">ServiceWorker</span> <span class="keyword">implements</span> <span class="title class_">Runnable</span> &#123;</span><br><span class="line"></span><br><span class="line">            <span class="meta">@Override</span></span><br><span class="line">            <span class="keyword">public</span> <span class="keyword">void</span> <span class="title function_">run</span><span class="params">()</span> &#123;</span><br><span class="line">                <span class="keyword">while</span> (!mIsServiceDestoryed.get()) &#123;</span><br><span class="line">                    <span class="keyword">try</span> &#123;</span><br><span class="line">                        Thread.sleep(<span class="number">5000</span>);</span><br><span class="line">                    &#125; <span class="keyword">catch</span> (InterruptedException e) &#123;</span><br><span class="line">                        e.printStackTrace();</span><br><span class="line">                    &#125;</span><br><span class="line">                    <span class="type">int</span> bookId=mBookList.size()+<span class="number">1</span>;</span><br><span class="line">                    <span class="type">Book</span> <span class="variable">newBook</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">Book</span>(bookId, <span class="string">&quot;new book#&quot;</span> + bookId);</span><br><span class="line">                    onNewBookArrived(newBook);</span><br><span class="line">                &#125;</span><br><span class="line">            &#125;</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;<span class="keyword">public</span> <span class="keyword">class</span> <span class="title class_">BookManagerService</span> <span class="keyword">extends</span> <span class="title class_">Service</span> &#123;</span><br><span class="line">    <span class="keyword">private</span> <span class="keyword">static</span> <span class="keyword">final</span> String TAG=<span class="string">&quot;BMS&quot;</span>;</span><br><span class="line">    <span class="keyword">private</span> AtomicBoolean mIsServiceDestoryed=<span class="keyword">new</span> <span class="title class_">AtomicBoolean</span>(<span class="literal">false</span>);</span><br><span class="line">    <span class="keyword">private</span> CopyOnWriteArrayList&lt;Book&gt; mBookList=<span class="keyword">new</span> <span class="title class_">CopyOnWriteArrayList</span>&lt;Book&gt;();</span><br><span class="line">    <span class="keyword">private</span>     CopyOnWriteArrayList&lt;IOnNewBookArrivedListener&gt; mListenerList=<span class="keyword">new</span> <span class="title class_">CopyOnWriteArrayList</span>&lt;IOnNewBookArrivedListener&gt;();</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">    <span class="keyword">private</span> Binder mBinder=<span class="keyword">new</span> <span class="title class_">IBookManager</span>.Stub() &#123;</span><br><span class="line">        <span class="meta">@Override</span></span><br><span class="line">        <span class="keyword">public</span> List&lt;Book&gt; <span class="title function_">getBookList</span><span class="params">()</span> <span class="keyword">throws</span> RemoteException &#123;</span><br><span class="line">            <span class="keyword">return</span> mBookList;</span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line">        <span class="meta">@Override</span></span><br><span class="line">        <span class="keyword">public</span> <span class="keyword">void</span> <span class="title function_">addBook</span><span class="params">(Book book)</span> <span class="keyword">throws</span> RemoteException &#123;</span><br><span class="line">    mBookList.add(book);</span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line">        <span class="meta">@Override</span></span><br><span class="line">        <span class="keyword">public</span> <span class="keyword">void</span> <span class="title function_">registerListener</span><span class="params">(IOnNewBookArrivedListener listener)</span> <span class="keyword">throws</span> RemoteException &#123;</span><br><span class="line">            <span class="keyword">if</span>(!mListenerList.contains(listener))&#123;</span><br><span class="line">                mListenerList.add(listener);</span><br><span class="line">            &#125;<span class="keyword">else</span> &#123;</span><br><span class="line">                Log.d(TAG, <span class="string">&quot;already exists&quot;</span>);</span><br><span class="line">            &#125;</span><br><span class="line">            Log.d(TAG, <span class="string">&quot;registerListener,size:&quot;</span>+mListenerList.size());</span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line">        <span class="meta">@Override</span></span><br><span class="line">        <span class="keyword">public</span> <span class="keyword">void</span> <span class="title function_">unregisterListener</span><span class="params">(IOnNewBookArrivedListener listener)</span> <span class="keyword">throws</span> RemoteException &#123;</span><br><span class="line">                    <span class="keyword">if</span>(mListenerList.contains(listener))&#123;</span><br><span class="line">                        mListenerList.remove(listener);</span><br><span class="line">                        Log.d(TAG, <span class="string">&quot;unregister listener succeed.&quot;</span>);</span><br><span class="line">                    &#125;<span class="keyword">else</span> &#123;</span><br><span class="line">                        Log.d(TAG, <span class="string">&quot;not found,can not unregister.&quot;</span>);</span><br><span class="line">                    &#125;</span><br><span class="line">            Log.d(TAG, <span class="string">&quot;unregisterListener:,current size:&quot;</span>+mListenerList.size());</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;;</span><br><span class="line"></span><br><span class="line">    <span class="meta">@Override</span></span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">void</span> <span class="title function_">onCreate</span><span class="params">()</span> &#123;</span><br><span class="line">        <span class="built_in">super</span>.onCreate();</span><br><span class="line">        mBookList.add(<span class="keyword">new</span> <span class="title class_">Book</span>(<span class="number">1</span>,<span class="string">&quot;Android&quot;</span>));</span><br><span class="line">        mBookList.add(<span class="keyword">new</span> <span class="title class_">Book</span>(<span class="number">2</span>,<span class="string">&quot;Ios&quot;</span>));</span><br><span class="line">        <span class="keyword">new</span> <span class="title class_">Thread</span>(<span class="keyword">new</span> <span class="title class_">ServiceWorker</span>()).start();</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="meta">@Override</span></span><br><span class="line">    <span class="keyword">public</span> IBinder <span class="title function_">onBind</span><span class="params">(Intent intent)</span> &#123;</span><br><span class="line">        <span class="keyword">return</span> mBinder;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="meta">@Override</span></span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">void</span> <span class="title function_">onDestroy</span><span class="params">()</span> &#123;</span><br><span class="line">        mIsServiceDestoryed.set(<span class="literal">true</span>);</span><br><span class="line">        <span class="built_in">super</span>.onDestroy();</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">private</span> <span class="keyword">void</span> <span class="title function_">onNewBookArrived</span><span class="params">(Book book)</span> <span class="keyword">throws</span> RemoteException&#123;</span><br><span class="line">        mBookList.add(book);</span><br><span class="line">        Log.d(TAG, <span class="string">&quot;onNewBookArrived,notify listeners:&quot;</span>+mListenerList.size());</span><br><span class="line">        <span class="keyword">for</span>(<span class="type">int</span> i=<span class="number">0</span>;i&lt;mListenerList.size();i++)&#123;</span><br><span class="line">            IOnNewBookArrivedListener listener=mListenerList.get(i);</span><br><span class="line">            Log.d(TAG, <span class="string">&quot;onNewBookArrived,notify listeners:&quot;</span>+listener);</span><br><span class="line">            listener.onNewBookArrived(book);</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">private</span> <span class="keyword">class</span> <span class="title class_">ServiceWorker</span> <span class="keyword">implements</span> <span class="title class_">Runnable</span>&#123;</span><br><span class="line"></span><br><span class="line">        <span class="meta">@Override</span></span><br><span class="line">        <span class="keyword">public</span> <span class="keyword">void</span> <span class="title function_">run</span><span class="params">()</span> &#123;</span><br><span class="line">            <span class="keyword">while</span>(!mIsServiceDestoryed.get())&#123;</span><br><span class="line">                <span class="keyword">try</span>&#123;</span><br><span class="line">                    Thread.sleep(<span class="number">5000</span>);</span><br><span class="line"></span><br><span class="line">                &#125;<span class="keyword">catch</span> (InterruptedException e)&#123;</span><br><span class="line">                    e.printStackTrace();</span><br><span class="line">                &#125;</span><br><span class="line">                <span class="type">int</span> bookId=mBookList.size()+<span class="number">1</span>;</span><br><span class="line">                Book newBook=<span class="keyword">new</span> <span class="title class_">Book</span>(bookId,<span class="string">&quot;new book#&quot;</span>+bookId);</span><br><span class="line">                <span class="keyword">try</span> &#123;</span><br><span class="line">                    onNewBookArrived(newBook);</span><br><span class="line">                &#125;<span class="keyword">catch</span> (RemoteException e)&#123;</span><br><span class="line">                    e.printStackTrace();</span><br><span class="line">                &#125;</span><br><span class="line">            &#125;</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>


</li>
<li><p>客户端</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="keyword">class</span> <span class="title class_">BookManagerActivity</span> <span class="keyword">extends</span> <span class="title class_">AppCompatActivity</span> &#123;</span><br><span class="line"><span class="keyword">private</span> <span class="keyword">static</span> <span class="keyword">final</span> String TAG=<span class="string">&quot;BookManagerActivity&quot;</span>;</span><br><span class="line"><span class="keyword">private</span> <span class="keyword">static</span> <span class="keyword">final</span> <span class="type">int</span> MESSAGE_NEW_BOOK_ARRIVED=<span class="number">1</span>;</span><br><span class="line"><span class="keyword">private</span> IBookManager mRemoteBookManager;</span><br><span class="line"><span class="meta">@SuppressLint(&quot;HandlerLeak&quot;)</span></span><br><span class="line"><span class="keyword">private</span> Handler mHandler=<span class="keyword">new</span> <span class="title class_">Handler</span>()&#123;</span><br><span class="line">    <span class="meta">@Override</span></span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">void</span> <span class="title function_">handleMessage</span><span class="params">(<span class="meta">@NonNull</span> Message msg)</span> &#123;</span><br><span class="line">        <span class="keyword">switch</span> (msg.what)&#123;</span><br><span class="line">            <span class="keyword">case</span> MESSAGE_NEW_BOOK_ARRIVED:</span><br><span class="line">                Log.d(TAG, <span class="string">&quot;received new book:&quot;</span>+msg.obj);</span><br><span class="line">                <span class="keyword">break</span>;</span><br><span class="line">            <span class="keyword">default</span>:</span><br><span class="line">                <span class="built_in">super</span>.handleMessage(msg);</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;;</span><br><span class="line"><span class="keyword">private</span> ServiceConnection mConnection=<span class="keyword">new</span> <span class="title class_">ServiceConnection</span>() &#123;</span><br><span class="line">    <span class="meta">@Override</span></span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">void</span> <span class="title function_">onServiceConnected</span><span class="params">(ComponentName name, IBinder service)</span> &#123;</span><br><span class="line">        IBookManager bookManager=IBookManager.Stub.asInterface(service);</span><br><span class="line">        <span class="keyword">try</span> &#123;</span><br><span class="line">            mRemoteBookManager=bookManager;</span><br><span class="line">            List&lt;Book&gt; list=bookManager.getBookList();</span><br><span class="line">            Log.i(TAG, <span class="string">&quot;query book list,list type:&quot;</span>+list.getClass().getCanonicalName());</span><br><span class="line">            Log.i(TAG, <span class="string">&quot;query book list：&quot;</span>+list.toString());</span><br><span class="line">            Book newBook=<span class="keyword">new</span> <span class="title class_">Book</span>(<span class="number">3</span>,<span class="string">&quot;Android开发艺术探索&quot;</span>);</span><br><span class="line">            bookManager.addBook(newBook);</span><br><span class="line">            Log.i(TAG, <span class="string">&quot;add book: &quot;</span>+newBook);</span><br><span class="line">            List&lt;Book&gt;newList=bookManager.getBookList();</span><br><span class="line">            Log.i(TAG, <span class="string">&quot;query book list: &quot;</span>+newList.toString());</span><br><span class="line">            bookManager.registerListener(mOnNewBookArrivedListener);</span><br><span class="line">        &#125;<span class="keyword">catch</span> (RemoteException e)&#123;</span><br><span class="line">            e.printStackTrace();</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="meta">@Override</span></span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">void</span> <span class="title function_">onServiceDisconnected</span><span class="params">(ComponentName name)</span> &#123;</span><br><span class="line">mRemoteBookManager=<span class="literal">null</span>;</span><br><span class="line">        Log.e(TAG, <span class="string">&quot;binder died&quot;</span> );</span><br><span class="line">    &#125;</span><br><span class="line">&#125;;</span><br><span class="line"><span class="keyword">private</span> IOnNewBookArrivedListener mOnNewBookArrivedListener=<span class="keyword">new</span> <span class="title class_">IOnNewBookArrivedListener</span>.Stub() &#123;</span><br><span class="line">    <span class="meta">@Override</span></span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">void</span> <span class="title function_">onNewBookArrived</span><span class="params">(Book newBook)</span> <span class="keyword">throws</span> RemoteException &#123;</span><br><span class="line">        mHandler.obtainMessage(MESSAGE_NEW_BOOK_ARRIVED,newBook).sendToTarget();</span><br><span class="line">    &#125;</span><br><span class="line">&#125;;</span><br><span class="line"></span><br><span class="line">    <span class="meta">@Override</span></span><br><span class="line">    <span class="keyword">protected</span> <span class="keyword">void</span> <span class="title function_">onCreate</span><span class="params">(Bundle savedInstanceState)</span> &#123;</span><br><span class="line">        <span class="built_in">super</span>.onCreate(savedInstanceState);</span><br><span class="line">        setContentView(R.layout.activity_main);</span><br><span class="line">        Intent intent=<span class="keyword">new</span> <span class="title class_">Intent</span>(<span class="built_in">this</span>,BookManagerService.class);</span><br><span class="line">        bindService(intent,mConnection, Context.BIND_AUTO_CREATE);</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="meta">@Override</span></span><br><span class="line">    <span class="keyword">protected</span> <span class="keyword">void</span> <span class="title function_">onDestroy</span><span class="params">()</span> &#123;</span><br><span class="line">        <span class="keyword">if</span>(mRemoteBookManager!=<span class="literal">null</span>&amp;&amp;mRemoteBookManager.asBinder().isBinderAlive())&#123;</span><br><span class="line">            <span class="keyword">try</span> &#123;</span><br><span class="line">                Log.i(TAG, <span class="string">&quot;unregister listener:&quot;</span>+mOnNewBookArrivedListener);</span><br><span class="line">                mRemoteBookManager.unregisterListener(mOnNewBookArrivedListener);</span><br><span class="line">            &#125;<span class="keyword">catch</span> (RemoteException e)&#123;</span><br><span class="line">                e.printStackTrace();</span><br><span class="line">            &#125;</span><br><span class="line">        &#125;</span><br><span class="line">        unbindService(mConnection);</span><br><span class="line">        <span class="built_in">super</span>.onDestroy();</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure></li>
</ol>
</li>
<li><p><strong>RemoteCallbackList专为AIDL设计的方法</strong></p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">//是系统专门提供的用于删除跨进程listener的接口 </span></span><br><span class="line"><span class="comment">//自我清理：最核心功能。自动移除已死亡客户端的监听器，防止内存泄漏和异常。</span></span><br><span class="line"><span class="comment">//专用性：只用于 AIDL 跨进程回调，不是一个通用的 List。</span></span><br><span class="line"><span class="comment">//线程安全：所有操作（注册、注销、遍历）都是为多线程环境设计的。</span></span><br><span class="line"><span class="comment">//广播式遍历：必须使用 beginBroadcast/finishBroadcast 的固定模式来安全地通知所有监听器。</span></span><br></pre></td></tr></table></figure>

</li>
<li><p><strong>给服务加上权限验证的功能</strong></p>
<ol>
<li><p>在onBind中进行验证</p>
<ul>
<li><p>permission方法验证</p>
<figure class="highlight xml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line"><span class="tag">&lt;<span class="name">permission</span> <span class="attr">android:name</span>=<span class="string">&quot;com.example.ipctest.permission.ACCESS_BOOK_SERVICE&quot;</span></span></span><br><span class="line"><span class="tag">        <span class="attr">android:protectionLevel</span>=<span class="string">&quot;normal&quot;</span>/&gt;</span></span><br></pre></td></tr></table></figure>

<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">@Override</span></span><br><span class="line">        <span class="keyword">public</span> IBinder <span class="title function_">onBind</span><span class="params">(Intent intent)</span> &#123;          </span><br><span class="line">          <span class="type">int</span>         check=checkCallingOrSelfPermission(<span class="string">&quot;com.example.ipctest.permission.ACCESS_BOOK_SERVICE&quot;</span>);</span><br><span class="line">            <span class="keyword">if</span>(check== PackageManager.PERMISSION_DENIED)&#123;</span><br><span class="line">                <span class="keyword">return</span> <span class="literal">null</span>;</span><br><span class="line">            &#125;</span><br><span class="line">            <span class="keyword">return</span> mBinder;</span><br><span class="line">        &#125;</span><br></pre></td></tr></table></figure>
</li>
<li><p>如果内部应用想绑定这个服务</p>
<figure class="highlight xml"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"><span class="tag">&lt;<span class="name">user-permission</span> <span class="attr">android:name</span>=<span class="string">&quot;com.example.ipctest.permission.ACCESS_BOOK_SERVICE&quot;</span>/&gt;</span></span><br></pre></td></tr></table></figure></li>
</ul>
</li>
<li><p>在服务端的onTransact进行权限验证</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">@Override</span></span><br><span class="line"><span class="keyword">public</span> <span class="type">boolean</span> <span class="title function_">onTransact</span><span class="params">(<span class="type">int</span> code, Parcel data, Parcel reply, <span class="type">int</span> flags)</span> <span class="keyword">throws</span> RemoteException &#123;</span><br><span class="line">    <span class="type">int</span> check=checkCallingOrSelfPermission(<span class="string">&quot;com.example.ipctest.permission.ACCESS_BOOK_SERVICE&quot;</span>);</span><br><span class="line">    <span class="keyword">if</span>(check==PackageManager.PERMISSION_DENIED)&#123;</span><br><span class="line">        <span class="keyword">return</span> <span class="literal">false</span>;</span><br><span class="line">    &#125;</span><br><span class="line">    String packageName=<span class="literal">null</span>;</span><br><span class="line">    String[] packages=getPackageManager().getPackagesForUid(getCallingUid());</span><br><span class="line">    <span class="keyword">if</span>(packages!=<span class="literal">null</span>&amp;&amp;packages.length&gt;<span class="number">0</span>)&#123;</span><br><span class="line">        packageName=packages[<span class="number">0</span>];</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">if</span>(!packageName.startsWith(<span class="string">&quot;com.example&quot;</span>))&#123;</span><br><span class="line">        <span class="keyword">return</span> <span class="literal">false</span>;</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">return</span> <span class="built_in">super</span>.onTransact(code, data, reply, flags);</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure></li>
</ol>
</li>
</ul>
<hr>
<h3 id="ContentProvider"><a href="#ContentProvider" class="headerlink" title="ContentProvider"></a>ContentProvider</h3><ul>
<li><p>创建一个数据库</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="keyword">class</span> <span class="title class_">DbOpenHelper</span> <span class="keyword">extends</span> <span class="title class_">SQLiteOpenHelper</span> &#123;</span><br><span class="line">    <span class="keyword">private</span> <span class="keyword">static</span> <span class="keyword">final</span> String DB_NAME=<span class="string">&quot;book_provider.db&quot;</span>;</span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">final</span> String BOOK_TABLE_NAME=<span class="string">&quot;book&quot;</span>;</span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">final</span> String USER_TABLE_NAME=<span class="string">&quot;user&quot;</span>;</span><br><span class="line">    <span class="keyword">private</span> <span class="keyword">static</span> <span class="keyword">final</span> <span class="type">int</span> DB_VERSION=<span class="number">1</span>;</span><br><span class="line">    <span class="keyword">private</span> <span class="keyword">static</span> <span class="keyword">final</span> <span class="type">String</span> <span class="variable">CREATE_BOOK_TABLE</span> <span class="operator">=</span> <span class="string">&quot;create table book(&quot;</span></span><br><span class="line">            + <span class="string">&quot;id integer primary key, &quot;</span></span><br><span class="line">            + <span class="string">&quot;name text)&quot;</span>;</span><br><span class="line">    <span class="keyword">private</span> <span class="keyword">static</span> <span class="keyword">final</span> String CREATE_USER_TABLE=<span class="string">&quot;create table user(&quot;</span></span><br><span class="line">            +<span class="string">&quot;id integer primary key,&quot;</span></span><br><span class="line">            +<span class="string">&quot;name text,&quot;</span></span><br><span class="line">            +<span class="string">&quot;sex int)&quot;</span>;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">public</span> <span class="title function_">DbOpenHelper</span><span class="params">(<span class="meta">@Nullable</span> Context context)</span> &#123;</span><br><span class="line">        <span class="built_in">super</span>(context,DB_NAME,<span class="literal">null</span>,DB_VERSION);</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="meta">@Override</span></span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">void</span> <span class="title function_">onCreate</span><span class="params">(SQLiteDatabase db)</span> &#123;</span><br><span class="line">db.execSQL(CREATE_BOOK_TABLE);</span><br><span class="line">db.execSQL(CREATE_USER_TABLE);</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="meta">@Override</span></span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">void</span> <span class="title function_">onUpgrade</span><span class="params">(SQLiteDatabase db, <span class="type">int</span> oldVersion, <span class="type">int</span> newVersion)</span> &#123;</span><br><span class="line"></span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>




</li>
<li><p>创建一个ContentProvider，并注册</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br><span class="line">95</span><br><span class="line">96</span><br><span class="line">97</span><br><span class="line">98</span><br><span class="line">99</span><br><span class="line">100</span><br><span class="line">101</span><br><span class="line">102</span><br><span class="line">103</span><br><span class="line">104</span><br><span class="line">105</span><br><span class="line">106</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="keyword">class</span> <span class="title class_">BookProvider</span> <span class="keyword">extends</span> <span class="title class_">ContentProvider</span> &#123;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">private</span> <span class="keyword">static</span> <span class="keyword">final</span> String TAG=<span class="string">&quot;BookProvider&quot;</span>;</span><br><span class="line">    <span class="keyword">private</span> <span class="keyword">static</span> <span class="keyword">final</span> String AUTHORITY=<span class="string">&quot;com.example.contentprovider.book.provider&quot;</span>;</span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">final</span> Uri BOOK_CONTENT_URI=Uri.parse(<span class="string">&quot;content://&quot;</span>+AUTHORITY+<span class="string">&quot;/book&quot;</span>);</span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">final</span> Uri USER_CONTENT_URI=Uri.parse(<span class="string">&quot;content://&quot;</span>+AUTHORITY+<span class="string">&quot;/user&quot;</span>);</span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">final</span> <span class="type">int</span> BOOK_URI_CODE=<span class="number">0</span>;</span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">final</span> <span class="type">int</span> USER_URI_CODE=<span class="number">1</span>;</span><br><span class="line">    <span class="keyword">private</span> <span class="keyword">static</span> <span class="keyword">final</span> UriMatcher sUriMatcher=<span class="keyword">new</span> <span class="title class_">UriMatcher</span>(UriMatcher.NO_MATCH);</span><br><span class="line">    <span class="keyword">static</span> &#123;</span><br><span class="line">        sUriMatcher.addURI(AUTHORITY,<span class="string">&quot;book&quot;</span>,BOOK_URI_CODE);</span><br><span class="line">        sUriMatcher.addURI(AUTHORITY,<span class="string">&quot;user&quot;</span>,USER_URI_CODE);</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">private</span> SQLiteDatabase db;</span><br><span class="line">    <span class="keyword">private</span> String <span class="title function_">getTableName</span><span class="params">(Uri uri)</span>&#123;</span><br><span class="line">        String tableName=<span class="literal">null</span>;</span><br><span class="line">        <span class="keyword">switch</span> (sUriMatcher.match(uri))&#123;</span><br><span class="line">            <span class="keyword">case</span>  BOOK_URI_CODE:</span><br><span class="line">                tableName=DbOpenHelper.BOOK_TABLE_NAME;</span><br><span class="line">                <span class="keyword">break</span>;</span><br><span class="line">            <span class="keyword">case</span> USER_URI_CODE:</span><br><span class="line">                tableName=DbOpenHelper.USER_TABLE_NAME;</span><br><span class="line">                <span class="keyword">break</span>;</span><br><span class="line">            <span class="keyword">default</span>:<span class="keyword">break</span>;</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="keyword">return</span> tableName;</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="meta">@Override</span></span><br><span class="line">    <span class="keyword">public</span> <span class="type">int</span> <span class="title function_">delete</span><span class="params">(<span class="meta">@NonNull</span> Uri uri, <span class="meta">@Nullable</span> String selection, <span class="meta">@Nullable</span> String[] selectionArgs)</span> &#123;</span><br><span class="line">        Log.d(TAG, <span class="string">&quot;delete: &quot;</span>);</span><br><span class="line">        String table=getTableName(uri);</span><br><span class="line">        <span class="keyword">if</span> (table==<span class="literal">null</span>)&#123;</span><br><span class="line">            <span class="keyword">throw</span> <span class="keyword">new</span> <span class="title class_">IllegalArgumentException</span>(<span class="string">&quot;Unsupported URI:&quot;</span>+uri);</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="type">int</span> count=db.delete(table,selection,selectionArgs);</span><br><span class="line">        <span class="keyword">if</span>(count&gt;<span class="number">0</span>)&#123;</span><br><span class="line">            getContext().getContentResolver().notifyChange(uri,<span class="literal">null</span>);</span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line">        <span class="keyword">return</span> count;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="meta">@Nullable</span></span><br><span class="line">    <span class="meta">@Override</span></span><br><span class="line">    <span class="keyword">public</span> String <span class="title function_">getType</span><span class="params">(<span class="meta">@NonNull</span> Uri uri)</span> &#123;</span><br><span class="line">        Log.d(TAG, <span class="string">&quot;getType:&quot;</span>);</span><br><span class="line">        <span class="keyword">return</span> <span class="literal">null</span>;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="meta">@Nullable</span></span><br><span class="line">    <span class="meta">@Override</span></span><br><span class="line">    <span class="keyword">public</span> Uri <span class="title function_">insert</span><span class="params">(<span class="meta">@NonNull</span> Uri uri, <span class="meta">@Nullable</span> ContentValues values)</span> &#123;</span><br><span class="line">        Log.d(TAG, <span class="string">&quot;insert: &quot;</span>);</span><br><span class="line">        String table=getTableName(uri);</span><br><span class="line">        <span class="keyword">if</span> (table==<span class="literal">null</span>)&#123;</span><br><span class="line">            <span class="keyword">throw</span> <span class="keyword">new</span> <span class="title class_">IllegalArgumentException</span>(<span class="string">&quot;Unsupported URI:&quot;</span>+uri);</span><br><span class="line">        &#125;</span><br><span class="line">        db.insert(table,<span class="literal">null</span>,values);</span><br><span class="line">        getContext().getContentResolver().notifyChange(uri,<span class="literal">null</span>);</span><br><span class="line">        <span class="keyword">return</span> uri;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="meta">@Override</span></span><br><span class="line">    <span class="keyword">public</span> <span class="type">boolean</span> <span class="title function_">onCreate</span><span class="params">()</span> &#123;</span><br><span class="line">        DbOpenHelper dbOpenHelper=<span class="keyword">new</span> <span class="title class_">DbOpenHelper</span>(getContext());</span><br><span class="line">        db=dbOpenHelper.getWritableDatabase();</span><br><span class="line">        <span class="comment">//初始化数据库，这里仅用作演示，实际操作中不推荐在主线程执行耗时操作</span></span><br><span class="line">        initProviderData();</span><br><span class="line">        Log.d(TAG, <span class="string">&quot;onCreate:,current thread:&quot;</span>+Thread.currentThread().getName());</span><br><span class="line">        <span class="keyword">return</span> <span class="literal">true</span>;</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">private</span> <span class="keyword">void</span> <span class="title function_">initProviderData</span><span class="params">()</span>&#123;</span><br><span class="line">        db.execSQL(<span class="string">&quot;delete from &quot;</span>+DbOpenHelper.BOOK_TABLE_NAME);</span><br><span class="line">        db.execSQL(<span class="string">&quot;delete from &quot;</span>+DbOpenHelper.USER_TABLE_NAME);</span><br><span class="line">        db.execSQL(<span class="string">&quot;insert into book values(3,&#x27;Android&#x27;);&quot;</span>);</span><br><span class="line">        db.execSQL(<span class="string">&quot;insert into book values(4,&#x27;Ios&#x27;);&quot;</span>);</span><br><span class="line">        db.execSQL(<span class="string">&quot;insert into book values(5,&#x27;Html5&#x27;);&quot;</span>);</span><br><span class="line">        db.execSQL(<span class="string">&quot;insert into user values(1,&#x27;jake&#x27;,1);&quot;</span>);</span><br><span class="line">        db.execSQL(<span class="string">&quot;insert into user values(2,&#x27;jasmine&#x27;,0);&quot;</span>);</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="meta">@Nullable</span></span><br><span class="line">    <span class="meta">@Override</span></span><br><span class="line">    <span class="keyword">public</span> Cursor <span class="title function_">query</span><span class="params">(<span class="meta">@NonNull</span> Uri uri, <span class="meta">@Nullable</span> String[] projection, <span class="meta">@Nullable</span> String selection, <span class="meta">@Nullable</span> String[] selectionArgs, <span class="meta">@Nullable</span> String sortOrder)</span> &#123;</span><br><span class="line">        Log.d(TAG, <span class="string">&quot;onCreate:,current thread:&quot;</span>+Thread.currentThread().getName());</span><br><span class="line">        String table=getTableName(uri);</span><br><span class="line">        <span class="keyword">if</span>(table==<span class="literal">null</span>)&#123;</span><br><span class="line">            <span class="keyword">throw</span> <span class="keyword">new</span> <span class="title class_">IllegalArgumentException</span>(<span class="string">&quot;Unsupported URI:&quot;</span>+uri);</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="keyword">return</span> db.query(table,projection,selection,selectionArgs,<span class="literal">null</span>,<span class="literal">null</span>,sortOrder,<span class="literal">null</span>);</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="meta">@Override</span></span><br><span class="line">    <span class="keyword">public</span> <span class="type">int</span> <span class="title function_">update</span><span class="params">(<span class="meta">@NonNull</span> Uri uri, <span class="meta">@Nullable</span> ContentValues values, <span class="meta">@Nullable</span> String selection, <span class="meta">@Nullable</span> String[] selectionArgs)</span> &#123;</span><br><span class="line">        Log.d(TAG, <span class="string">&quot;update: &quot;</span>);</span><br><span class="line">        String table=getTableName(uri);</span><br><span class="line">        <span class="keyword">if</span>(table==<span class="literal">null</span>)&#123;</span><br><span class="line">            <span class="keyword">throw</span> <span class="keyword">new</span> <span class="title class_">IllegalArgumentException</span>(<span class="string">&quot;Unsupported URI:&quot;</span>+uri);</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="type">int</span> row=db.update(table,values,selection,selectionArgs);</span><br><span class="line">        <span class="keyword">if</span>(row&gt;<span class="number">0</span>)&#123;</span><br><span class="line">            getContext().getContentResolver().notifyChange(uri,<span class="literal">null</span>);</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="keyword">return</span> row;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br></pre></td></tr></table></figure>

<figure class="highlight xml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line"><span class="tag">&lt;<span class="name">provider</span></span></span><br><span class="line"><span class="tag">           <span class="attr">android:name</span>=<span class="string">&quot;.BookProvider&quot;</span></span></span><br><span class="line"><span class="tag">           <span class="attr">android:authorities</span>=<span class="string">&quot;com.example.contentprovider.book.provider&quot;</span></span></span><br><span class="line"><span class="tag">           <span class="attr">android:permission</span>=<span class="string">&quot;com.example.PROVIDER&quot;</span></span></span><br><span class="line"><span class="tag">           <span class="attr">android:process</span>=<span class="string">&quot;:provider&quot;</span></span></span><br><span class="line"><span class="tag">           &gt;</span></span><br><span class="line">       <span class="tag">&lt;/<span class="name">provider</span>&gt;</span></span><br></pre></td></tr></table></figure>
</li>
<li><p>应用到Activity中</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="keyword">class</span> <span class="title class_">MainActivity</span> <span class="keyword">extends</span> <span class="title class_">AppCompatActivity</span> &#123;</span><br><span class="line">    <span class="keyword">private</span> <span class="keyword">static</span> <span class="keyword">final</span> String TAG=<span class="string">&quot;MainActivity&quot;</span>;</span><br><span class="line"></span><br><span class="line">    <span class="meta">@Override</span></span><br><span class="line">    <span class="keyword">protected</span> <span class="keyword">void</span> <span class="title function_">onCreate</span><span class="params">(Bundle savedInstanceState)</span> &#123;</span><br><span class="line">        <span class="built_in">super</span>.onCreate(savedInstanceState);</span><br><span class="line">        setContentView(R.layout.activity_main);</span><br><span class="line">        Uri uri=Uri.parse(<span class="string">&quot;content://com.example.contentprovider.book.provider&quot;</span>);</span><br><span class="line">        Uri bookUri=Uri.parse(<span class="string">&quot;content://com.example.contentprovider.book.provider/book&quot;</span>);</span><br><span class="line">        ContentValues values=<span class="keyword">new</span> <span class="title class_">ContentValues</span>();</span><br><span class="line">        values.put(<span class="string">&quot;id&quot;</span>,<span class="number">6</span>);</span><br><span class="line">        values.put(<span class="string">&quot;name&quot;</span>,<span class="string">&quot;程序设计的艺术&quot;</span>);</span><br><span class="line">        getContentResolver().insert(bookUri,values);</span><br><span class="line">        Cursor bookCursor=getContentResolver().query(bookUri,<span class="keyword">new</span> <span class="title class_">String</span>[]&#123;<span class="string">&quot;id&quot;</span>,<span class="string">&quot;name&quot;</span>&#125;,<span class="literal">null</span>,<span class="literal">null</span>,<span class="literal">null</span>);</span><br><span class="line">        <span class="keyword">while</span>(bookCursor.moveToNext())&#123;</span><br><span class="line">            Book book=<span class="keyword">new</span> <span class="title class_">Book</span>();</span><br><span class="line">            book.bookId=bookCursor.getInt(<span class="number">0</span>);</span><br><span class="line">            book.bookName=bookCursor.getString(<span class="number">1</span>);</span><br><span class="line">            Log.d(TAG, <span class="string">&quot;query book:&quot;</span>+book.toString());</span><br><span class="line">        &#125;</span><br><span class="line">        bookCursor.close();</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">        Uri userUri=Uri.parse(<span class="string">&quot;content://com.example.contentprovider.book.provider/user&quot;</span>);</span><br><span class="line">        Cursor userCursor=getContentResolver().query(userUri,<span class="keyword">new</span> <span class="title class_">String</span>[]&#123;<span class="string">&quot;id&quot;</span>,<span class="string">&quot;name&quot;</span>,<span class="string">&quot;sex&quot;</span>&#125;,<span class="literal">null</span>,<span class="literal">null</span>,<span class="literal">null</span>);</span><br><span class="line">        <span class="keyword">while</span>(userCursor.moveToNext())&#123;</span><br><span class="line">            User user=<span class="keyword">new</span> <span class="title class_">User</span>();</span><br><span class="line">            user.userId=userCursor.getInt(<span class="number">0</span>);</span><br><span class="line">            user.userName=userCursor.getString(<span class="number">1</span>);</span><br><span class="line">            user.isMale=userCursor.getInt(<span class="number">2</span>)==<span class="number">1</span>;</span><br><span class="line">            Log.d(TAG, <span class="string">&quot;query user:&quot;</span>+user.toString());</span><br><span class="line">        &#125;</span><br><span class="line">        userCursor.close();</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<hr>
<h3 id="Socket"><a href="#Socket" class="headerlink" title="Socket"></a>Socket</h3></li>
<li><p><strong>服务端</strong></p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br><span class="line">95</span><br><span class="line">96</span><br><span class="line">97</span><br><span class="line">98</span><br><span class="line">99</span><br><span class="line">100</span><br><span class="line">101</span><br><span class="line">102</span><br><span class="line">103</span><br><span class="line">104</span><br><span class="line">105</span><br><span class="line">106</span><br><span class="line">107</span><br><span class="line">108</span><br><span class="line">109</span><br><span class="line">110</span><br><span class="line">111</span><br><span class="line">112</span><br><span class="line">113</span><br><span class="line">114</span><br><span class="line">115</span><br><span class="line">116</span><br><span class="line">117</span><br><span class="line">118</span><br><span class="line">119</span><br><span class="line">120</span><br><span class="line">121</span><br><span class="line">122</span><br><span class="line">123</span><br><span class="line">124</span><br><span class="line">125</span><br><span class="line">126</span><br><span class="line">127</span><br><span class="line">128</span><br><span class="line">129</span><br><span class="line">130</span><br><span class="line">131</span><br><span class="line">132</span><br><span class="line">133</span><br><span class="line">134</span><br><span class="line">135</span><br><span class="line">136</span><br><span class="line">137</span><br><span class="line">138</span><br><span class="line">139</span><br><span class="line">140</span><br><span class="line">141</span><br><span class="line">142</span><br><span class="line">143</span><br><span class="line">144</span><br><span class="line">145</span><br><span class="line">146</span><br><span class="line">147</span><br><span class="line">148</span><br><span class="line">149</span><br><span class="line">150</span><br><span class="line">151</span><br><span class="line">152</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">/**</span></span><br><span class="line"><span class="comment"> * 一个在后台运行的TCP服务器Service。</span></span><br><span class="line"><span class="comment"> * &lt;p&gt;</span></span><br><span class="line"><span class="comment"> * 这个服务启动后，会在8688端口上监听客户端的TCP连接请求。</span></span><br><span class="line"><span class="comment"> * 它能够同时处理多个客户端的连接，并与每个客户端进行简单的随机消息交互。</span></span><br><span class="line"><span class="comment"> */</span></span><br><span class="line"><span class="keyword">public</span> <span class="keyword">class</span> <span class="title class_">TCPServerService</span> <span class="keyword">extends</span> <span class="title class_">Service</span> &#123;</span><br><span class="line">    <span class="comment">/**</span></span><br><span class="line"><span class="comment">     * 标志位，用于表示Service是否已经被销毁。</span></span><br><span class="line"><span class="comment">     * 当Service被销毁时，此标志位会变为true，从而通知所有正在运行的线程优雅地停止。</span></span><br><span class="line"><span class="comment">     */</span></span><br><span class="line">    <span class="keyword">private</span> <span class="type">boolean</span> <span class="variable">mIsServiceDestoryed</span> <span class="operator">=</span> <span class="literal">false</span>;</span><br><span class="line"></span><br><span class="line">    <span class="comment">/**</span></span><br><span class="line"><span class="comment">     * 预定义的消息数组，服务器会从中随机选择一条回复给客户端。</span></span><br><span class="line"><span class="comment">     */</span></span><br><span class="line">    <span class="keyword">private</span> String[] mDefinedMessagges = <span class="keyword">new</span> <span class="title class_">String</span>[]&#123;</span><br><span class="line">            <span class="string">&quot;你好啊，哈哈&quot;</span>,</span><br><span class="line">            <span class="string">&quot;请问你叫什么名字呀？&quot;</span>,</span><br><span class="line">            <span class="string">&quot;今天北京天气不错呀，shy&quot;</span>,</span><br><span class="line">            <span class="string">&quot;你知道吗？我可是可以和多个人同时聊天的哦&quot;</span>,</span><br><span class="line">            <span class="string">&quot;给你讲个笑话吧，据说爱笑的人运气不会太差，不知道真假.&quot;</span></span><br><span class="line">    &#125;;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">public</span> <span class="title function_">TCPServerService</span><span class="params">()</span> &#123;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="comment">/**</span></span><br><span class="line"><span class="comment">     * Service创建时调用，是服务的生命周期入口。</span></span><br><span class="line"><span class="comment">     * 在这里，我们启动一个新的线程来运行TCP服务器的核心逻辑。</span></span><br><span class="line"><span class="comment">     */</span></span><br><span class="line">    <span class="meta">@Override</span></span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">void</span> <span class="title function_">onCreate</span><span class="params">()</span> &#123;</span><br><span class="line">        <span class="comment">// 创建一个新的线程来运行TCPServer任务。</span></span><br><span class="line">        <span class="comment">// 网络操作属于耗时操作，必须在子线程中进行，否则会阻塞UI主线程，导致ANR（应用无响应）。</span></span><br><span class="line">        <span class="keyword">new</span> <span class="title class_">Thread</span>(<span class="keyword">new</span> <span class="title class_">TCPServer</span>()).start();</span><br><span class="line">        <span class="built_in">super</span>.onCreate();</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="comment">/**</span></span><br><span class="line"><span class="comment">     * 提供绑定服务的接口。</span></span><br><span class="line"><span class="comment">     * <span class="doctag">@return</span> 返回null表示这是一个非绑定的服务（Started Service），不与任何组件进行通信。</span></span><br><span class="line"><span class="comment">     */</span></span><br><span class="line">    <span class="meta">@Override</span></span><br><span class="line">    <span class="keyword">public</span> IBinder <span class="title function_">onBind</span><span class="params">(Intent intent)</span> &#123;</span><br><span class="line">        <span class="keyword">return</span> <span class="literal">null</span>;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="comment">/**</span></span><br><span class="line"><span class="comment">     * Service销毁时调用，是服务的生命周期终点。</span></span><br><span class="line"><span class="comment">     * 在这里，我们将mIsServiceDestoryed标志位置为true，通知所有线程停止工作。</span></span><br><span class="line"><span class="comment">     */</span></span><br><span class="line">    <span class="meta">@Override</span></span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">void</span> <span class="title function_">onDestroy</span><span class="params">()</span> &#123;</span><br><span class="line">        mIsServiceDestoryed = <span class="literal">true</span>;</span><br><span class="line">        <span class="built_in">super</span>.onDestroy();</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="comment">/**</span></span><br><span class="line"><span class="comment">     * 实现了Runnable接口的内部类，封装了TCP服务器的核心逻辑。</span></span><br><span class="line"><span class="comment">     * 这个类的run方法将在一个独立的线程中执行。</span></span><br><span class="line"><span class="comment">     */</span></span><br><span class="line">    <span class="keyword">private</span> <span class="keyword">class</span> <span class="title class_">TCPServer</span> <span class="keyword">implements</span> <span class="title class_">Runnable</span> &#123;</span><br><span class="line"></span><br><span class="line">        <span class="meta">@Override</span></span><br><span class="line">        <span class="keyword">public</span> <span class="keyword">void</span> <span class="title function_">run</span><span class="params">()</span> &#123;</span><br><span class="line">            <span class="type">ServerSocket</span> <span class="variable">serverSocket</span> <span class="operator">=</span> <span class="literal">null</span>;</span><br><span class="line">            <span class="keyword">try</span> &#123;</span><br><span class="line">                <span class="comment">// 在本地8688端口上创建并监听ServerSocket。</span></span><br><span class="line">                serverSocket = <span class="keyword">new</span> <span class="title class_">ServerSocket</span>(<span class="number">8688</span>);</span><br><span class="line">            &#125; <span class="keyword">catch</span> (IOException e) &#123;</span><br><span class="line">                System.err.println(<span class="string">&quot;establish tcp server failed ,port:8688&quot;</span>);</span><br><span class="line">                e.printStackTrace();</span><br><span class="line">                <span class="comment">// 如果端口被占用或创建失败，则直接返回，线程结束。</span></span><br><span class="line">                <span class="keyword">return</span>;</span><br><span class="line">            &#125;</span><br><span class="line"></span><br><span class="line">            <span class="comment">// 进入主循环，只要服务没有被销毁，就一直等待新的客户端连接。</span></span><br><span class="line">            <span class="keyword">while</span> (!mIsServiceDestoryed) &#123;</span><br><span class="line">                <span class="keyword">try</span> &#123;</span><br><span class="line">                    <span class="comment">// accept() 是一个阻塞方法，它会一直等待，直到有客户端连接成功。</span></span><br><span class="line">                    <span class="comment">// 连接成功后，它会返回一个代表该连接的Socket对象。</span></span><br><span class="line">                    <span class="keyword">final</span> <span class="type">Socket</span> <span class="variable">client</span> <span class="operator">=</span> serverSocket.accept();</span><br><span class="line">                    System.out.println(<span class="string">&quot;accept a new client&quot;</span>);</span><br><span class="line"></span><br><span class="line">                    <span class="comment">// 【核心】为每一个新的客户端连接都创建一个新的线程去处理。</span></span><br><span class="line">                    <span class="comment">// 这样可以实现并发处理多个客户端，主线程可以立刻回去继续等待下一个连接。</span></span><br><span class="line">                    <span class="keyword">new</span> <span class="title class_">Thread</span>() &#123;</span><br><span class="line">                        <span class="meta">@Override</span></span><br><span class="line">                        <span class="keyword">public</span> <span class="keyword">void</span> <span class="title function_">run</span><span class="params">()</span> &#123;</span><br><span class="line">                            <span class="keyword">try</span> &#123;</span><br><span class="line">                                responseClient(client);</span><br><span class="line">                            &#125; <span class="keyword">catch</span> (IOException e) &#123;</span><br><span class="line">                                e.printStackTrace();</span><br><span class="line">                            &#125;</span><br><span class="line">                        &#125;</span><br><span class="line">                    &#125;.start();</span><br><span class="line">                &#125; <span class="keyword">catch</span> (IOException e) &#123;</span><br><span class="line">                    <span class="comment">// 在accept过程中也可能出现IO异常</span></span><br><span class="line">                    e.printStackTrace();</span><br><span class="line">                &#125;</span><br><span class="line">            &#125;</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="comment">/**</span></span><br><span class="line"><span class="comment">     * 处理与单个客户端的所有通信。</span></span><br><span class="line"><span class="comment">     * 这个方法会在一个专门为该客户端创建的线程中运行。</span></span><br><span class="line"><span class="comment">     *</span></span><br><span class="line"><span class="comment">     * <span class="doctag">@param</span> client 代表与客户端连接的Socket通道。</span></span><br><span class="line"><span class="comment">     * <span class="doctag">@throws</span> IOException 在网络读写时可能会抛出IO异常。</span></span><br><span class="line"><span class="comment">     */</span></span><br><span class="line">    <span class="keyword">private</span> <span class="keyword">void</span> <span class="title function_">responseClient</span><span class="params">(Socket client)</span> <span class="keyword">throws</span> IOException &#123;</span><br><span class="line">        <span class="comment">// 用于从客户端读取数据。通过一系列包装，实现高效的按行读取。</span></span><br><span class="line">        <span class="type">BufferedReader</span> <span class="variable">in</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">BufferedReader</span>(<span class="keyword">new</span> <span class="title class_">InputStreamReader</span>(client.getInputStream()));</span><br><span class="line">        <span class="comment">// 用于向客户端发送数据。true参数表示开启自动行刷新，println后消息会立刻发送。</span></span><br><span class="line">        <span class="type">PrintWriter</span> <span class="variable">out</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">PrintWriter</span>(<span class="keyword">new</span> <span class="title class_">BufferedWriter</span>(<span class="keyword">new</span> <span class="title class_">OutputStreamWriter</span>(client.getOutputStream())), <span class="literal">true</span>);</span><br><span class="line"></span><br><span class="line">        <span class="comment">// 首先向客户端发送一条欢迎消息。</span></span><br><span class="line">        out.println(<span class="string">&quot;欢迎来到聊天室！&quot;</span>);</span><br><span class="line"></span><br><span class="line">        <span class="comment">// 进入通信循环，只要服务未被销毁并且客户端未断开连接，就一直持续。</span></span><br><span class="line">        <span class="keyword">while</span> (!mIsServiceDestoryed) &#123;</span><br><span class="line">            <span class="comment">// readLine() 是一个阻塞方法，会等待客户端发送一行消息。</span></span><br><span class="line">            <span class="type">String</span> <span class="variable">str</span> <span class="operator">=</span> in.readLine();</span><br><span class="line">            System.out.println(<span class="string">&quot;msg from client:&quot;</span> + str);</span><br><span class="line"></span><br><span class="line">            <span class="comment">// 如果readLine()返回null，表示客户端的Socket已关闭，即连接已断开。</span></span><br><span class="line">            <span class="keyword">if</span> (str == <span class="literal">null</span>) &#123;</span><br><span class="line">                <span class="comment">// 结束循环，准备关闭资源。</span></span><br><span class="line">                <span class="keyword">break</span>;</span><br><span class="line">            &#125;</span><br><span class="line"></span><br><span class="line">            <span class="comment">// 从预设消息中随机选择一条进行回复。</span></span><br><span class="line">            <span class="type">int</span> <span class="variable">i</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">Random</span>().nextInt(mDefinedMessagges.length);</span><br><span class="line">            <span class="type">String</span> <span class="variable">msg</span> <span class="operator">=</span> mDefinedMessagges[i];</span><br><span class="line">            out.println(msg);</span><br><span class="line">            System.out.println(<span class="string">&quot;send to client:&quot;</span> + msg);</span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line">        System.out.println(<span class="string">&quot;client quit.&quot;</span>);</span><br><span class="line">        <span class="comment">// 【重要】当循环结束时，必须关闭所有资源。</span></span><br><span class="line">        <span class="comment">// 先关闭输出流，再关闭输入流，最后关闭Socket。</span></span><br><span class="line">        <span class="comment">// 如果不关闭，会造成资源泄漏。</span></span><br><span class="line">        <span class="comment">// MyUtils.close是一个自定义的工具方法，用于安全地关闭流。</span></span><br><span class="line">        <span class="comment">// 如果没有，可以直接调用 out.close(); in.close();</span></span><br><span class="line">        MyUtils.close(out);</span><br><span class="line"></span><br><span class="line">        MyUtils.close(in);</span><br><span class="line">        client.close();</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>


</li>
<li><p><strong>客户端</strong></p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br><span class="line">95</span><br><span class="line">96</span><br><span class="line">97</span><br><span class="line">98</span><br><span class="line">99</span><br><span class="line">100</span><br><span class="line">101</span><br><span class="line">102</span><br><span class="line">103</span><br><span class="line">104</span><br><span class="line">105</span><br><span class="line">106</span><br><span class="line">107</span><br><span class="line">108</span><br><span class="line">109</span><br><span class="line">110</span><br><span class="line">111</span><br><span class="line">112</span><br><span class="line">113</span><br><span class="line">114</span><br><span class="line">115</span><br><span class="line">116</span><br><span class="line">117</span><br><span class="line">118</span><br><span class="line">119</span><br><span class="line">120</span><br><span class="line">121</span><br><span class="line">122</span><br><span class="line">123</span><br><span class="line">124</span><br><span class="line">125</span><br><span class="line">126</span><br><span class="line">127</span><br><span class="line">128</span><br><span class="line">129</span><br><span class="line">130</span><br><span class="line">131</span><br><span class="line">132</span><br><span class="line">133</span><br><span class="line">134</span><br><span class="line">135</span><br><span class="line">136</span><br><span class="line">137</span><br><span class="line">138</span><br><span class="line">139</span><br><span class="line">140</span><br><span class="line">141</span><br><span class="line">142</span><br><span class="line">143</span><br><span class="line">144</span><br><span class="line">145</span><br><span class="line">146</span><br><span class="line">147</span><br><span class="line">148</span><br><span class="line">149</span><br><span class="line">150</span><br><span class="line">151</span><br><span class="line">152</span><br><span class="line">153</span><br><span class="line">154</span><br><span class="line">155</span><br><span class="line">156</span><br><span class="line">157</span><br><span class="line">158</span><br><span class="line">159</span><br><span class="line">160</span><br><span class="line">161</span><br><span class="line">162</span><br><span class="line">163</span><br><span class="line">164</span><br><span class="line">165</span><br><span class="line">166</span><br><span class="line">167</span><br><span class="line">168</span><br><span class="line">169</span><br><span class="line">170</span><br><span class="line">171</span><br><span class="line">172</span><br><span class="line">173</span><br><span class="line">174</span><br><span class="line">175</span><br><span class="line">176</span><br><span class="line">177</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">/**</span></span><br><span class="line"><span class="comment"> * 这是一个TCP客户端界面 (Activity)。</span></span><br><span class="line"><span class="comment"> * 它的功能是连接到后台的TCPServerService，并与之进行消息收发。</span></span><br><span class="line"><span class="comment"> */</span></span><br><span class="line"><span class="keyword">public</span> <span class="keyword">class</span> <span class="title class_">TCPClientActivity</span> <span class="keyword">extends</span> <span class="title class_">AppCompatActivity</span> <span class="keyword">implements</span> <span class="title class_">View</span>.OnClickListener &#123;</span><br><span class="line">    <span class="comment">// 定义Handler能够识别的消息类型：1 表示收到新消息</span></span><br><span class="line">    <span class="keyword">private</span> <span class="keyword">static</span> <span class="keyword">final</span> <span class="type">int</span> <span class="variable">MESSAGE_RECEIVE_NEW_MSG</span> <span class="operator">=</span> <span class="number">1</span>;</span><br><span class="line">    <span class="comment">// 定义Handler能够识别的消息类型：2 表示Socket连接成功</span></span><br><span class="line">    <span class="keyword">private</span> <span class="keyword">static</span> <span class="keyword">final</span> <span class="type">int</span> <span class="variable">MESSAGE_SOCKET_CONNECTED</span> <span class="operator">=</span> <span class="number">2</span>;</span><br><span class="line"></span><br><span class="line">    <span class="comment">// UI控件</span></span><br><span class="line">    <span class="keyword">private</span> Button mSendButton;</span><br><span class="line">    <span class="keyword">private</span> TextView mMessageTextView;</span><br><span class="line">    <span class="keyword">private</span> EditText mMessageEditText;</span><br><span class="line"></span><br><span class="line">    <span class="comment">// 网络通信相关</span></span><br><span class="line">    <span class="keyword">private</span> PrintWriter mPrintWriter;<span class="comment">// 用于向服务器发送消息</span></span><br><span class="line">    <span class="keyword">private</span> Socket mClientSocket;<span class="comment">// 客户端的Socket</span></span><br><span class="line"></span><br><span class="line">    <span class="comment">/**</span></span><br><span class="line"><span class="comment">     * Handler是Android中用于线程间通信的关键组件。</span></span><br><span class="line"><span class="comment">     * 这里的Handler运行在主线程（UI线程）中，它可以接收来自任何子线程的消息，</span></span><br><span class="line"><span class="comment">     * 然后安全地在主线程中更新UI界面。子线程绝对不能直接操作UI！</span></span><br><span class="line"><span class="comment">     */</span></span><br><span class="line">    <span class="meta">@SuppressLint(&quot;HandlerLeak&quot;)</span></span><br><span class="line">    <span class="keyword">private</span> <span class="type">Handler</span> <span class="variable">handler</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">Handler</span>() &#123;</span><br><span class="line">        <span class="meta">@Override</span></span><br><span class="line">        <span class="keyword">public</span> <span class="keyword">void</span> <span class="title function_">handleMessage</span><span class="params">(<span class="meta">@NonNull</span> Message msg)</span> &#123;</span><br><span class="line">            <span class="comment">// 根据收到的消息类型(msg.what)来执行不同的操作</span></span><br><span class="line">            <span class="keyword">switch</span> (msg.what) &#123;</span><br><span class="line">                <span class="keyword">case</span> MESSAGE_RECEIVE_NEW_MSG: &#123;</span><br><span class="line">                    <span class="comment">// 如果是“收到新消息”，就把消息内容(msg.obj)追加到TextView上</span></span><br><span class="line">                    mMessageTextView.append((String) msg.obj);</span><br><span class="line">                    <span class="keyword">break</span>;</span><br><span class="line">                &#125;</span><br><span class="line">                <span class="keyword">case</span> MESSAGE_SOCKET_CONNECTED: &#123;</span><br><span class="line">                    <span class="comment">// 如果是“连接成功”，就把发送按钮变为可用状态</span></span><br><span class="line">                    mSendButton.setEnabled(<span class="literal">true</span>);</span><br><span class="line">                    <span class="keyword">break</span>;</span><br><span class="line">                &#125;</span><br><span class="line">                <span class="keyword">default</span>:</span><br><span class="line">                    <span class="keyword">break</span>;</span><br><span class="line">            &#125;</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;;</span><br><span class="line"></span><br><span class="line">    <span class="meta">@Override</span></span><br><span class="line">    <span class="keyword">protected</span> <span class="keyword">void</span> <span class="title function_">onCreate</span><span class="params">(<span class="meta">@Nullable</span> Bundle savedInstanceState)</span> &#123;</span><br><span class="line">        <span class="built_in">super</span>.onCreate(savedInstanceState);</span><br><span class="line">        <span class="comment">// 加载布局文件</span></span><br><span class="line">        setContentView(R.layout.activity_main);</span><br><span class="line"></span><br><span class="line">        <span class="comment">// 初始化UI控件</span></span><br><span class="line">        mMessageTextView = (TextView) findViewById(R.id.textView);</span><br><span class="line">        mSendButton = (Button) findViewById(R.id.send);</span><br><span class="line">        mSendButton.setOnClickListener(<span class="built_in">this</span>); <span class="comment">// 设置按钮的点击监听器</span></span><br><span class="line">        mMessageEditText = (EditText) findViewById(R.id.editText);</span><br><span class="line"></span><br><span class="line">        <span class="comment">// 启动后台TCP服务器服务</span></span><br><span class="line">        <span class="type">Intent</span> <span class="variable">service</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">Intent</span>(<span class="built_in">this</span>, TCPServerService.class);</span><br><span class="line">        startService(service);</span><br><span class="line"></span><br><span class="line">        <span class="comment">// 开启一个新的子线程来执行网络连接操作</span></span><br><span class="line">        <span class="comment">// 因为连接服务器是耗时操作，必须在子线程中进行，防止UI卡顿</span></span><br><span class="line">        <span class="keyword">new</span> <span class="title class_">Thread</span>() &#123;</span><br><span class="line">            <span class="meta">@Override</span></span><br><span class="line">            <span class="keyword">public</span> <span class="keyword">void</span> <span class="title function_">run</span><span class="params">()</span> &#123;</span><br><span class="line">                connectTCPServer();</span><br><span class="line">            &#125;</span><br><span class="line">        &#125;.start();</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">    <span class="comment">/**</span></span><br><span class="line"><span class="comment">     * Activity被销毁时调用。</span></span><br><span class="line"><span class="comment">     * 在这里我们需要关闭Socket连接，释放资源。</span></span><br><span class="line"><span class="comment">     */</span></span><br><span class="line">    <span class="meta">@Override</span></span><br><span class="line">    <span class="keyword">protected</span> <span class="keyword">void</span> <span class="title function_">onDestroy</span><span class="params">()</span> &#123;</span><br><span class="line">        <span class="keyword">if</span> (mClientSocket != <span class="literal">null</span>) &#123;</span><br><span class="line">            <span class="keyword">try</span> &#123;</span><br><span class="line">                <span class="comment">// 关闭Socket的输入流和连接</span></span><br><span class="line">                mClientSocket.shutdownInput();</span><br><span class="line">                mClientSocket.close();</span><br><span class="line">            &#125; <span class="keyword">catch</span> (IOException e) &#123;</span><br><span class="line">                e.printStackTrace();</span><br><span class="line">            &#125;</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="built_in">super</span>.onDestroy();</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">    <span class="comment">/**</span></span><br><span class="line"><span class="comment">     * 处理按钮点击事件。</span></span><br><span class="line"><span class="comment">     */</span></span><br><span class="line">    <span class="meta">@Override</span></span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">void</span> <span class="title function_">onClick</span><span class="params">(View v)</span> &#123;</span><br><span class="line">        <span class="keyword">if</span> (v == mSendButton) &#123;</span><br><span class="line">            <span class="keyword">final</span> <span class="type">String</span> <span class="variable">msg</span> <span class="operator">=</span> mMessageEditText.getText().toString();</span><br><span class="line">            <span class="comment">// 确保消息不为空，并且网络连接已准备好</span></span><br><span class="line">            <span class="keyword">if</span> (!TextUtils.isEmpty(msg) &amp;&amp; mPrintWriter != <span class="literal">null</span>) &#123;</span><br><span class="line">                <span class="comment">// 【关键】发送消息是网络操作，必须在子线程中进行，否则会闪退</span></span><br><span class="line">                <span class="keyword">new</span> <span class="title class_">Thread</span>(<span class="keyword">new</span> <span class="title class_">Runnable</span>() &#123;</span><br><span class="line">                    <span class="meta">@Override</span></span><br><span class="line">                    <span class="keyword">public</span> <span class="keyword">void</span> <span class="title function_">run</span><span class="params">()</span> &#123;</span><br><span class="line">                        mPrintWriter.println(msg);</span><br><span class="line">                    &#125;</span><br><span class="line">                &#125;).start();</span><br><span class="line"></span><br><span class="line">                <span class="comment">// 【关键】更新UI的操作（清空输入框、显示自己发送的消息）必须在主线程进行</span></span><br><span class="line">                mMessageEditText.setText(<span class="string">&quot;&quot;</span>);</span><br><span class="line">                <span class="type">String</span> <span class="variable">time</span> <span class="operator">=</span> formateDataTime(System.currentTimeMillis());</span><br><span class="line">                <span class="keyword">final</span> <span class="type">String</span> <span class="variable">showedMsg</span> <span class="operator">=</span> <span class="string">&quot;self &quot;</span> + time + <span class="string">&quot;:&quot;</span> + msg + <span class="string">&quot;\n&quot;</span>;</span><br><span class="line">                mMessageTextView.append(showedMsg);</span><br><span class="line">            &#125;</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="comment">/**</span></span><br><span class="line"><span class="comment">     * 一个简单的时间格式化工具方法</span></span><br><span class="line"><span class="comment">     */</span></span><br><span class="line">    <span class="meta">@SuppressLint(&quot;SimpleDateFormat&quot;)</span></span><br><span class="line">    <span class="keyword">private</span> String <span class="title function_">formateDataTime</span><span class="params">(<span class="type">long</span> time)</span> &#123;</span><br><span class="line">        <span class="keyword">return</span> <span class="keyword">new</span> <span class="title class_">SimpleDateFormat</span>(<span class="string">&quot;(HH:mm:ss)&quot;</span>).format(<span class="keyword">new</span> <span class="title class_">Date</span>(time));</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="comment">/**</span></span><br><span class="line"><span class="comment">     * 连接到TCP服务器的核心方法。</span></span><br><span class="line"><span class="comment">     * 这个方法会在一个子线程中被调用。</span></span><br><span class="line"><span class="comment">     */</span></span><br><span class="line">    <span class="keyword">private</span> <span class="keyword">void</span> <span class="title function_">connectTCPServer</span><span class="params">()</span> &#123;</span><br><span class="line">        <span class="type">Socket</span> <span class="variable">socket</span> <span class="operator">=</span> <span class="literal">null</span>;</span><br><span class="line">        <span class="comment">// 使用循环来尝试连接服务器，直到连接成功为止</span></span><br><span class="line">        <span class="comment">// 这样可以防止客户端比服务器先启动而导致连接失败</span></span><br><span class="line">        <span class="keyword">while</span> (socket == <span class="literal">null</span>) &#123;</span><br><span class="line">            <span class="keyword">try</span> &#123;</span><br><span class="line">                <span class="comment">// 尝试连接本地（模拟器/真机自身）的8688端口</span></span><br><span class="line">                socket = <span class="keyword">new</span> <span class="title class_">Socket</span>(<span class="string">&quot;localhost&quot;</span>, <span class="number">8688</span>);</span><br><span class="line">                mClientSocket = socket;</span><br><span class="line">                <span class="comment">// 创建PrintWriter，用于向服务器发送消息</span></span><br><span class="line">                mPrintWriter = <span class="keyword">new</span> <span class="title class_">PrintWriter</span>(<span class="keyword">new</span> <span class="title class_">BufferedWriter</span>(<span class="keyword">new</span> <span class="title class_">OutputStreamWriter</span>(socket.getOutputStream())), <span class="literal">true</span>);</span><br><span class="line">                <span class="comment">// 连接成功后，通过Handler向主线程发送“连接成功”的消息</span></span><br><span class="line">                handler.sendEmptyMessage(MESSAGE_SOCKET_CONNECTED);</span><br><span class="line">                System.out.println(<span class="string">&quot;connect server success&quot;</span>);</span><br><span class="line">            &#125; <span class="keyword">catch</span> (IOException e) &#123;</span><br><span class="line">                <span class="comment">// 如果连接失败，则等待1秒后重试</span></span><br><span class="line">                SystemClock.sleep(<span class="number">1000</span>);</span><br><span class="line">                System.out.println(<span class="string">&quot;connect tcp server failed, retry...&quot;</span>);</span><br><span class="line">            &#125;</span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line">        <span class="keyword">try</span> &#123;</span><br><span class="line">            <span class="comment">// 连接成功后，准备接收服务器端的消息</span></span><br><span class="line">            <span class="type">BufferedReader</span> <span class="variable">br</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">BufferedReader</span>(<span class="keyword">new</span> <span class="title class_">InputStreamReader</span>(socket.getInputStream()));</span><br><span class="line">            <span class="comment">// 只要Activity没有被关闭，就一直循环读取服务器消息</span></span><br><span class="line">            <span class="keyword">while</span> (!TCPClientActivity.<span class="built_in">this</span>.isFinishing()) &#123;</span><br><span class="line">                <span class="comment">// readLine()是一个阻塞方法，会一直等待直到读取到一行消息</span></span><br><span class="line">                <span class="type">String</span> <span class="variable">msg</span> <span class="operator">=</span> br.readLine();</span><br><span class="line">                System.out.println(<span class="string">&quot;receive :&quot;</span> + msg);</span><br><span class="line">                <span class="keyword">if</span> (msg != <span class="literal">null</span>) &#123;</span><br><span class="line">                    <span class="comment">// 收到消息后，格式化一下</span></span><br><span class="line">                    <span class="type">String</span> <span class="variable">time</span> <span class="operator">=</span> formateDataTime(System.currentTimeMillis());</span><br><span class="line">                    <span class="keyword">final</span> <span class="type">String</span> <span class="variable">showedMsg</span> <span class="operator">=</span> <span class="string">&quot;server &quot;</span> + time + <span class="string">&quot;:&quot;</span> + msg + <span class="string">&quot;\n&quot;</span>;</span><br><span class="line">                    <span class="comment">// 通过Handler把收到的消息发送给主线程，让主线程去更新UI</span></span><br><span class="line">                    handler.obtainMessage(MESSAGE_RECEIVE_NEW_MSG, showedMsg).sendToTarget();</span><br><span class="line">                &#125;</span><br><span class="line">            &#125;</span><br><span class="line">            <span class="comment">// 退出循环后，说明Activity要关闭了，清理资源</span></span><br><span class="line">            System.out.println(<span class="string">&quot;quit...&quot;</span>);</span><br><span class="line">            MyUtils.close(mPrintWriter);</span><br><span class="line">            MyUtils.close(br);</span><br><span class="line">            socket.close();</span><br><span class="line">        &#125; <span class="keyword">catch</span> (IOException e) &#123;</span><br><span class="line">            e.printStackTrace();</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure></li>
</ul>
</article><div class="post-copyright"><div class="post-copyright__author"><span class="post-copyright-meta"><i class="fas fa-circle-user fa-fw"></i>文章作者: </span><span class="post-copyright-info"><a href="https://buyu6.github.io">Aurora</a></span></div><div class="post-copyright__type"><span class="post-copyright-meta"><i class="fas fa-square-arrow-up-right fa-fw"></i>文章链接: </span><span class="post-copyright-info"><a href="https://buyu6.github.io/posts/Android%E4%B8%AD%E7%9A%84IPC%E6%96%B9%E5%BC%8F/">https://buyu6.github.io/posts/Android%E4%B8%AD%E7%9A%84IPC%E6%96%B9%E5%BC%8F/</a></span></div><div class="post-copyright__notice"><span class="post-copyright-meta"><i class="fas fa-circle-exclamation fa-fw"></i>版权声明: </span><span class="post-copyright-info">本博客所有文章除特别声明外，均采用 <a href="https://creativecommons.org/licenses/by-nc-sa/4.0/" target="_blank">CC BY-NC-SA 4.0</a> 许可协议。转载请注明来源 <a href="https://buyu6.github.io" target="_blank">Auroraの世界</a>！</span></div></div><div class="tag_share"><div class="post-share"><div class="social-share" data-image="/bgImg/bg4.jpg" data-sites="facebook,x,wechat,weibo,qq"></div><link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/butterfly-extsrc@1.1.6/sharejs/dist/css/share.min.css" media="print" onload="this.media='all'"><script src="https://cdn.jsdelivr.net/npm/butterfly-extsrc@1.1.6/sharejs/dist/js/social-share.min.js" defer></script></div></div><nav class="pagination-post" id="pagination"><a class="pagination-related" href="/posts/Binder%E8%BF%9E%E6%8E%A5%E6%B1%A0/" title="Binder连接池"><img class="cover" src="/bgImg/bg3.jpg" onerror="onerror=null;src='/img/404.jpg'" alt="cover of previous post"><div class="info"><div class="info-1"><div class="info-item-1">上一篇</div><div class="info-item-2">Binder连接池</div></div><div class="info-2"><div class="info-item-1"> 先创建不同需求的AIDL接口 12345678910interface ICompute &#123;//计算加法的功能    int add(int a,int b);&#125;interface ISecurityCenter &#123;//加密   String encrypt(String content);   //解密   String decrypt(String password);&#125;    对创建的接口进行实现 123456789101112131415161718192021222324public class ComputeImpl  extends  ICompute.Stub&#123;    @Override    public int add(int a, int b) throws RemoteException &#123;        return a+b;    &#125;&#125;public class SecurityCenterImpl extends ISecurityCenter.Stub&#123;   ...</div></div></div></a><a class="pagination-related" href="/posts/IPC%E5%9F%BA%E7%A1%80%E6%A6%82%E5%BF%B5/" title="IPC基础概念"><img class="cover" src="/bgImg/bg5.jpg" onerror="onerror=null;src='/img/404.jpg'" alt="cover of next post"><div class="info text-right"><div class="info-1"><div class="info-item-1">下一篇</div><div class="info-item-2">IPC基础概念</div></div><div class="info-2"><div class="info-item-1">Serializable接口Serializable接口的实现 123456public class User implements Serializable &#123;    private static final long serialVersionUID=519067123721295773L;//辅助序列化和反序列化过程    public int userId;    public String userName;    public boolean isMale; &#125;  序列化和反序列化的实现 123456789101112//序列化过程User user=new User(0,&quot;jack&quot;,true);// 1. 创建一个User对象ObjectOutputStream out=new ObjectOutputStream(// 2. 创建一个对象输出流    new FileOutputStream(&quot;cache.txt&quot;)//它包裹了一个文件输入流，指向 &quot;cache.txt&quot;);out....</div></div></div></a></nav></div><div class="aside-content" id="aside-content"><div class="card-widget card-info text-center"><div class="avatar-img"><img src="/img/avatar.jpg" onerror="this.onerror=null;this.src='/img/friend_404.gif'" alt="avatar"/></div><div class="author-info-name">Aurora</div><div class="author-info-description">分享学习历程，编程技术以及笔记随笔等</div><div class="site-data"><a href="/archives/"><div class="headline">文章</div><div class="length-num">68</div></a><a href="/tags/"><div class="headline">标签</div><div class="length-num">0</div></a><a href="/categories/"><div class="headline">分类</div><div class="length-num">11</div></a></div><a id="card-info-btn" target="_blank" rel="noopener" href="https://github.com/buyu6"><i class="fab fa-github"></i><span>My GitHub</span></a><div class="card-info-social-icons"><a class="social-icon" href="https://github.com/buyu6" target="_blank" title="Github"><i class="fab fa-github" style="color: #24292e;"></i></a><a class="social-icon" href="mailto:yu2006059@gmail.com" target="_blank" title="Email"><i class="fas fa-envelope" style="color: #4a7dbe;"></i></a></div></div><div class="card-widget card-announcement"><div class="item-headline"><i class="fas fa-bullhorn fa-shake"></i><span>公告</span></div><div class="announcement_content">This is my Blog</div></div><div class="sticky_layout"><div class="card-widget" id="card-toc"><div class="item-headline"><i class="fas fa-stream"></i><span>目录</span><span class="toc-percentage"></span></div><div class="toc-content"><ol class="toc"><li class="toc-item toc-level-3"><a class="toc-link" href="#Bundle"><span class="toc-number">1.</span> <span class="toc-text">Bundle</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#%E4%BD%BF%E7%94%A8%E6%96%87%E4%BB%B6%E5%85%B1%E4%BA%AB"><span class="toc-number">2.</span> <span class="toc-text">使用文件共享</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#Messenger"><span class="toc-number">3.</span> <span class="toc-text">Messenger</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#AIDL"><span class="toc-number">4.</span> <span class="toc-text">AIDL</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#ContentProvider"><span class="toc-number">5.</span> <span class="toc-text">ContentProvider</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#Socket"><span class="toc-number">6.</span> <span class="toc-text">Socket</span></a></li></ol></div></div><div class="card-widget card-recent-post"><div class="item-headline"><i class="fas fa-history"></i><span>最新文章</span></div><div class="aside-list"><div class="aside-list-item"><a class="thumbnail" href="/posts/%E5%B0%86%E5%85%A8%E6%99%AF%E5%9B%BE%E5%BA%94%E7%94%A8%E5%88%B0%E9%A1%B9%E7%9B%AE%E7%9A%84%E6%96%B9%E6%B3%95/" title="将全景图应用到项目的方法"><img src="/bgImg/bg1.jpg" onerror="this.onerror=null;this.src='/img/404.jpg'" alt="将全景图应用到项目的方法"/></a><div class="content"><a class="title" href="/posts/%E5%B0%86%E5%85%A8%E6%99%AF%E5%9B%BE%E5%BA%94%E7%94%A8%E5%88%B0%E9%A1%B9%E7%9B%AE%E7%9A%84%E6%96%B9%E6%B3%95/" title="将全景图应用到项目的方法">将全景图应用到项目的方法</a><time datetime="2025-11-03T11:04:53.000Z" title="发表于 2025-11-03 19:04:53">2025-11-03</time></div></div><div class="aside-list-item"><a class="thumbnail" href="/posts/IPC%E7%9A%84%E4%BC%98%E7%BC%BA%E7%82%B9/" title="IPC的优缺点"><img src="/bgImg/bg2.jpg" onerror="this.onerror=null;this.src='/img/404.jpg'" alt="IPC的优缺点"/></a><div class="content"><a class="title" href="/posts/IPC%E7%9A%84%E4%BC%98%E7%BC%BA%E7%82%B9/" title="IPC的优缺点">IPC的优缺点</a><time datetime="2025-10-17T13:46:17.000Z" title="发表于 2025-10-17 21:46:17">2025-10-17</time></div></div><div class="aside-list-item"><a class="thumbnail" href="/posts/Binder%E8%BF%9E%E6%8E%A5%E6%B1%A0/" title="Binder连接池"><img src="/bgImg/bg3.jpg" onerror="this.onerror=null;this.src='/img/404.jpg'" alt="Binder连接池"/></a><div class="content"><a class="title" href="/posts/Binder%E8%BF%9E%E6%8E%A5%E6%B1%A0/" title="Binder连接池">Binder连接池</a><time datetime="2025-10-16T15:01:02.000Z" title="发表于 2025-10-16 23:01:02">2025-10-16</time></div></div><div class="aside-list-item"><a class="thumbnail" href="/posts/Android%E4%B8%AD%E7%9A%84IPC%E6%96%B9%E5%BC%8F/" title="Android中的IPC方式"><img src="/bgImg/bg4.jpg" onerror="this.onerror=null;this.src='/img/404.jpg'" alt="Android中的IPC方式"/></a><div class="content"><a class="title" href="/posts/Android%E4%B8%AD%E7%9A%84IPC%E6%96%B9%E5%BC%8F/" title="Android中的IPC方式">Android中的IPC方式</a><time datetime="2025-10-09T13:24:30.000Z" title="发表于 2025-10-09 21:24:30">2025-10-09</time></div></div><div class="aside-list-item"><a class="thumbnail" href="/posts/IPC%E5%9F%BA%E7%A1%80%E6%A6%82%E5%BF%B5/" title="IPC基础概念"><img src="/bgImg/bg5.jpg" onerror="this.onerror=null;this.src='/img/404.jpg'" alt="IPC基础概念"/></a><div class="content"><a class="title" href="/posts/IPC%E5%9F%BA%E7%A1%80%E6%A6%82%E5%BF%B5/" title="IPC基础概念">IPC基础概念</a><time datetime="2025-09-29T11:19:33.000Z" title="发表于 2025-09-29 19:19:33">2025-09-29</time></div></div></div></div></div></div></main><footer id="footer"><div class="footer-other"><div class="footer-copyright"><span class="copyright">&copy;&nbsp;2025 By Aurora</span><span class="framework-info"><span>框架 </span><a target="_blank" rel="noopener" href="https://hexo.io">Hexo 8.1.1</a><span class="footer-separator">|</span><span>主题 </span><a target="_blank" rel="noopener" href="https://github.com/jerryc127/hexo-theme-butterfly">Butterfly 5.5.3</a></span></div></div></footer></div><div id="rightside"><div id="rightside-config-hide"><button id="readmode" type="button" title="阅读模式"><i class="fas fa-book-open"></i></button><button id="darkmode" type="button" title="日间和夜间模式切换"><i class="fas fa-adjust"></i></button><button id="hide-aside-btn" type="button" title="单栏和双栏切换"><i class="fas fa-arrows-alt-h"></i></button></div><div id="rightside-config-show"><button id="rightside-config" type="button" title="设置"><i class="fas fa-cog fa-spin"></i></button><button class="close" id="mobile-toc-button" type="button" title="目录"><i class="fas fa-list-ul"></i></button><button id="go-up" type="button" title="回到顶部"><span class="scroll-percent"></span><i class="fas fa-arrow-up"></i></button></div></div><div><script src="/js/utils.js?v=5.5.3"></script><script src="/js/main.js?v=5.5.3"></script><div class="js-pjax"></div><script src="/js/auto_footer.js"></script><script>document.addEventListener("DOMContentLoaded", function() { var script = document.querySelector('script[src*="busuanzi.ibruce.info"]'); if (script) { script.remove(); } });</script><script async src="https://sdn.geekzu.org/ajax/ajax/libs/busuanzi/2.3/busuanzi.pure.mini.js"></script><script async data-pjax src="https://sdn.geekzu.org/ajax/ajax/libs/busuanzi/2.3/busuanzi.pure.mini.js"></script><div id="local-search"><div class="search-dialog"><nav class="search-nav"><span class="search-dialog-title">搜索</span><i class="fas fa-spinner fa-pulse" id="loading-status" hidden="hidden"></i><button class="search-close-button"><i class="fas fa-times"></i></button></nav><div class="text-center" id="loading-database"><i class="fas fa-spinner fa-pulse"></i><span>  数据加载中</span></div><div class="local-search-input"><input placeholder="搜索文章" type="text"/></div><hr/><div id="local-search-results"></div><div class="ais-Pagination" id="local-search-pagination" style="display:none;"><ul class="ais-Pagination-list"></ul></div><div id="local-search-stats"></div></div><div id="search-mask"></div><script src="/js/search/local-search.js?v=5.5.3"></script></div></div></body></html>